<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coded | Chats</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000000;
      color: #FFFFFF;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      flex-direction: column;
      background: #000000;
      border-bottom: 1px solid #1F1F1F;
      z-index: 100;
      padding-bottom: 12px;
    }
    .search-bar {
      display: flex;
      align-items: center;
      padding: 12px 16px 8px;
      gap: 12px;
    }
    .search-input {
      flex: 1;
      background: #1F1F1F;
      border: none;
      border-radius: 24px;
      padding: 12px 16px;
      color: #FFFFFF;
      font-size: 16px;
      outline: none;
    }
    .search-input::placeholder { color: #8E8E8E; }
    .header-icons { 
      position: absolute;
      right: 16px;
      top: 16px;
      display: flex; 
      gap: 20px; 
    }
    .header-icon { width: 24px; height: 24px; cursor: pointer; fill: #FFFFFF; }
    .chat-list { 
      flex: 1; 
      overflow-y: auto; 
      padding: 140px 24px 80px;
      position: relative;
    }
    .chat-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .chat-item:hover { background: #1F1F1F; }
    .profile-photo {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 16px;
      background: #2A2A2A;
      position: relative;
      flex-shrink: 0;
    }
    .profile-photo img { width: 100%; height: 100%; object-fit: cover; }
    .online-dot {
      position: absolute;
      bottom: 4px;
      right: 4px;
      width: 12px;
      height: 12px;
      background: #00FF00;
      border-radius: 50%;
      border: 2px solid #000000;
      box-shadow: 0 0 8px #00FF0080;
    }
    .chat-details { flex: 1; overflow: hidden; }
    .chat-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .last-message {
      font-size: 14px;
      color: #A0A0A0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .last-message-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      fill: #A0A0A0;
    }
    .chat-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
    .timestamp { font-size: 12px; color: #8E8E8E; }
    .unread-count {
      background: #1E90FF;
      color: #FFFFFF;
      font-size: 12px;
      font-weight: 600;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
    }
    /* Updated Empty State - centered and hidden during loading */
    .empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 24px;
      text-align: center;
      pointer-events: none; /* allows scrolling through if needed */
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s ease;
    }
    .empty-state.show {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .empty-icon { width: 120px; height: 120px; margin-bottom: 32px; opacity: 0.3; }
    .empty-title { font-size: 20px; margin-bottom: 12px; }
    .empty-subtitle { font-size: 16px; color: #8E8E8E; line-height: 1.5; }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      height: 64px;
      background: #1F1F1F;
      border-top: 1px solid #2A2A2A;
      z-index: 100;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #8E8E8E;
      cursor: pointer;
    }
    .nav-item.active { color: #FFFFFF; }
    .nav-icon svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
    .fab {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 64px;
      height: 64px;
      background: #FFFFFF;
      color: #000000;
      border-radius: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      cursor: pointer;
      z-index: 101;
    }
    .fab svg { width: 32px; height: 32px; fill: currentColor; }
    #toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(31, 31, 31, 0.95);
      color: #FFFFFF;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 200;
      max-width: 90%;
      text-align: center;
      backdrop-filter: blur(8px);
    }
    #toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-8px);
    }
    .logo-small { width: 40px; height: 40px; }
    .logo-small img { width: 100%; height: 100%; object-fit: contain; }

    /* Shimmer Loading */
    .shimmer-wrapper {
      position: absolute;
      inset: 0;
      padding: 0 24px;
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.4s ease;
      z-index: 10;
    }
    .shimmer-wrapper.hidden { opacity: 0; visibility: hidden; }
    .shimmer-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      animation: pulse 2s infinite ease-in-out;
    }
    .shimmer-photo { width: 56px; height: 56px; border-radius: 50%; background: #2A2A2A; margin-right: 16px; }
    .shimmer-details { flex: 1; }
    .shimmer-name { height: 16px; width: 50%; background: #2A2A2A; border-radius: 8px; margin-bottom: 8px; }
    .shimmer-msg { height: 14px; width: 70%; background: #2A2A2A; border-radius: 8px; }
    .shimmer-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
    .shimmer-time { height: 12px; width: 40px; background: #2A2A2A; border-radius: 8px; }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body>
  <header>
    <div class="search-bar">
      <div class="logo-small">
        <img src="asset/logo.png" alt="Coded Logo">
      </div>
      <input type="text" class="search-input" id="search-input" placeholder="Search chats...">
    </div>
    <div class="header-icons"></div>
  </header>

  <div class="chat-list" id="chat-list">
    <!-- Shimmer skeleton -->
    <div class="shimmer-wrapper" id="shimmer">
      <div class="shimmer-item">
        <div class="shimmer-photo"></div>
        <div class="shimmer-details">
          <div class="shimmer-name"></div>
          <div class="shimmer-msg"></div>
        </div>
        <div class="shimmer-meta">
          <div class="shimmer-time"></div>
        </div>
      </div>
      <div class="shimmer-item">
        <div class="shimmer-photo"></div>
        <div class="shimmer-details">
          <div class="shimmer-name"></div>
          <div class="shimmer-msg"></div>
        </div>
        <div class="shimmer-meta">
          <div class="shimmer-time"></div>
        </div>
      </div>
      <div class="shimmer-item">
        <div class="shimmer-photo"></div>
        <div class="shimmer-details">
          <div class="shimmer-name"></div>
          <div class="shimmer-msg"></div>
        </div>
        <div class="shimmer-meta">
          <div class="shimmer-time"></div>
        </div>
      </div>
      <div class="shimmer-item">
        <div class="shimmer-photo"></div>
        <div class="shimmer-details">
          <div class="shimmer-name"></div>
          <div class="shimmer-msg"></div>
        </div>
        <div class="shimmer-meta">
          <div class="shimmer-time"></div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="empty-state">
      <div class="empty-icon">ðŸ’¬</div>
      <div class="empty-title">No chats yet</div>
      <div class="empty-subtitle">Start a conversation to connect with others</div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-item" id="nav-live">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/></svg>
      </div>
      <div>Live</div>
    </div>
    <div class="nav-item" id="nav-favorites">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
      </div>
      <div>Favorites</div>
    </div>
    <div class="nav-item"></div>
    <div class="nav-item active" id="nav-chats">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>
      </div>
      <div>Chats</div>
    </div>
    <div class="nav-item" id="nav-profile">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      </div>
      <div>Profile</div>
    </div>

    <button class="fab" id="fab-post" aria-label="Post Request">
      <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </button>
  </div>

  <div id="toast"></div>

  <script>
    const fallbackImage = 'https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png';

    function showToast(message, duration = 2000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      clearTimeout(toast.hideTimeout);
      toast.hideTimeout = setTimeout(() => toast.classList.remove('show'), duration);
    }

    (function() {
      const token = localStorage.getItem('token');
      if (!token) {
        showToast('Please log in first.');
        setTimeout(() => window.location.href = 'login.html', 1500);
        return;
      }

      let currentUserId = null;

      function parseJwt(token) {
        try {
          const base64Url = token.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
          const payload = JSON.parse(jsonPayload);
          return payload.userId || payload.sub || payload.id || null;
        } catch (e) {
          console.error('Failed to parse JWT:', e);
          return null;
        }
      }

      currentUserId = parseJwt(token);

      const chatListEl = document.getElementById('chat-list');
      const emptyStateEl = document.getElementById('empty-state');
      const shimmerEl = document.getElementById('shimmer');
      const searchInput = document.getElementById('search-input');
      let allChats = [];

      async function loadChats() {
        // Show shimmer, hide empty state
        shimmerEl.classList.remove('hidden');
        emptyStateEl.classList.remove('show');

        try {
          const res = await fetch('https://codedsignal.org/chats', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const data = await res.json();

          allChats = Array.isArray(data) ? data : [];

          // Hide shimmer
          shimmerEl.classList.add('hidden');

          renderChats(allChats);
        } catch (err) {
          console.error('Chats load error:', err);
          showToast('Failed to load chats');
          shimmerEl.classList.add('hidden');
          emptyStateEl.classList.add('show');
          emptyStateEl.querySelector('.empty-title').textContent = 'Failed to load';
          emptyStateEl.querySelector('.empty-subtitle').innerHTML = 'Check your connection and try again<br><button onclick="location.reload()" style="margin-top:20px;padding:10px 20px;background:#FFF;color:#000;border:none;border-radius:20px;">Retry</button>';
        }
      }

      function renderChats(chats) {
        chatListEl.innerHTML = ''; // clear old content (shimmer already hidden)

        if (chats.length === 0) {
          emptyStateEl.classList.add('show');
          emptyStateEl.querySelector('.empty-title').textContent = 'No chats yet';
          emptyStateEl.querySelector('.empty-subtitle').textContent = 'Start a conversation to connect with others';
          return;
        }

        emptyStateEl.classList.remove('show');

        chats.forEach(chat => {
          const partner = chat.partner || { name: 'Unknown', avatar: fallbackImage, status: 'offline' };
          const isOnline = partner.status === 'available';

          let lastPreview = 'No messages yet';
          let previewIcon = '';

          if (chat.lastMessage) {
            const msg = chat.lastMessage;

            if (msg.type === 'image') {
              lastPreview = 'Photo';
              previewIcon = '<svg class="last-message-icon" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>';
            } else if (msg.type === 'text' && msg.content) {
              lastPreview = msg.content;
            } else if (typeof msg === 'string') {
              if (msg.trim() === '') {
                lastPreview = 'No messages yet';
              } else if (msg.includes('res.cloudinary.com')) {
                lastPreview = 'Photo';
                previewIcon = '<svg class="last-message-icon" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>';
              } else {
                lastPreview = msg.trim();
              }
            }
          }

          const unreadCount = chat.unreadCount || 0;
          const unreadBadge = unreadCount > 0 
            ? `<div class="unread-count">${unreadCount > 99 ? '99+' : unreadCount}</div>` 
            : '';

          const item = document.createElement('div');
          item.className = 'chat-item';
          item.dataset.chatId = chat.id;
          item.dataset.userId = partner.id || '';
          item.innerHTML = `
            <div class="profile-photo">
              <img src="${partner.avatar || fallbackImage}" alt="${partner.name}" onerror="this.src='${fallbackImage}'">
              ${isOnline ? '<div class="online-dot"></div>' : ''}
            </div>
            <div class="chat-details">
              <div class="chat-name">${partner.name || 'Unknown'}</div>
              <div class="last-message">
                ${previewIcon}
                ${lastPreview}
              </div>
            </div>
            <div class="chat-meta">
              <div class="timestamp">${formatTimestamp(chat.lastMessageAt)}</div>
              ${unreadBadge}
            </div>
          `;
          chatListEl.appendChild(item);
        });
      }

      function formatTimestamp(unix) {
        if (!unix) return '';
        const date = new Date(unix * 1000);
        const now = new Date();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);

        if (diffSec < 60) return 'Just now';
        if (diffSec < 3600) return Math.floor(diffSec / 60) + 'm';
        if (diffSec < 86400) return Math.floor(diffSec / 3600) + 'h';

        return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      }

      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase().trim();

        if (query === '') {
          renderChats(allChats);
          return;
        }

        const filtered = allChats.filter(chat => {
          const partner = chat.partner || {};
          const name = (partner.name || '').toLowerCase();
          return name.includes(query);
        });

        renderChats(filtered);

        if (filtered.length === 0) {
          emptyStateEl.classList.add('show');
          emptyStateEl.querySelector('.empty-title').textContent = 'No results';
          emptyStateEl.querySelector('.empty-subtitle').textContent = 'Try searching for a different name';
        }
      });

      chatListEl.addEventListener('click', e => {
        const item = e.target.closest('.chat-item');
        if (item) {
          const chatId = item.dataset.chatId;
          window.location.href = `chat.html?id=${chatId}`;
        }
      });

      document.addEventListener('click', (e) => {
        const profilePhoto = e.target.closest('.profile-photo');
        if (profilePhoto) {
          const item = profilePhoto.closest('.chat-item');
          const userId = item.dataset.userId;
          if (userId && userId !== currentUserId) {
            window.location.href = `view-profile.html?id=${userId}`;
            e.stopPropagation();
          }
        }
      });

      document.getElementById('nav-live').addEventListener('click', () => window.location.href = 'live-requests.html');
      document.getElementById('nav-favorites').addEventListener('click', () => window.location.href = 'favorites.html');
      document.getElementById('nav-chats').addEventListener('click', () => window.location.reload());
      document.getElementById('nav-profile').addEventListener('click', () => window.location.href = 'my-profile.html');

      document.getElementById('fab-post').addEventListener('click', () => {
        window.location.href = 'post.html';
      });

      loadChats();

      setInterval(loadChats, 30000);
    })();
  </script>
</body>
</html>