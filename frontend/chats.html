<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InstaPing | Chats</title>
  <link rel="icon" type="image/png" href="asset/logo.jpeg">
  <!-- theme-color updated to #00AEEF (primary brand color) -->
  <meta name="theme-color" content="#00AEEF">

  <style>
    /* === LIGHT MODE COLOR SCHEME (copied from live-requests page) === */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #FFFFFF;
      color: #000000;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header with white background, subtle border */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      flex-direction: column;
      background: #FFFFFF;
      border-bottom: 1px solid #E0E0E0;
      z-index: 100;
      padding-bottom: 12px;
    }
    .search-bar {
      display: flex;
      align-items: center;
      padding: 12px 16px 8px;
      gap: 12px;
    }
    .search-input {
      flex: 1;
      background: #F5F5F5;
      border: 1px solid #E0E0E0;
      border-radius: 24px;
      padding: 12px 16px;
      color: #000000;
      font-size: 16px;
      outline: none;
    }
    .search-input::placeholder { color: #8E8E8E; }
    .header-icons { 
      position: absolute;
      right: 16px;
      top: 16px;
      display: flex; 
      gap: 20px; 
    }
    .header-icon { width: 24px; height: 24px; cursor: pointer; fill: #000000; }

    /* Logo container: blue circle behind logo (primary #00AEEF) */
    .logo-small { 
      width: 40px; 
      height: 40px; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      position: relative;
    }
    .logo-small::before {
      content: '';
      position: absolute;
      width: 48px;
      height: 48px;
      background: #00AEEF; /* primary blue */
      border-radius: 50%;
      z-index: -1;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .logo-small img { 
      width: 100%; 
      height: 100%; 
      object-fit: contain; 
      position: relative;
      z-index: 1;
    }

    .chat-list { 
      flex: 1; 
      overflow-y: auto; 
      padding: 140px 24px 80px;
      position: relative;
    }
    .chat-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      cursor: pointer;
      transition: background 0.2s ease;
      border-bottom: 1px solid #F0F0F0;
    }
    .chat-item:hover, .chat-item:focus { 
      background: #F5F5F5; 
      outline: none;
    }
    .profile-photo {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 16px;
      background: #DDDDDD;
      position: relative;
      flex-shrink: 0;
    }
    .profile-photo img { width: 100%; height: 100%; object-fit: cover; }
    .online-dot {
      position: absolute;
      bottom: 4px;
      right: 4px;
      width: 12px;
      height: 12px;
      background: #00AEEF; /* primary color for online */
      border-radius: 50%;
      border: 2px solid #FFFFFF;
      box-shadow: 0 0 8px #00AEEF80;
    }
    .online-dot.busy { background: #FFFF00; }
    .online-dot.away { background: #FF0000; }
    .chat-details { flex: 1; overflow: hidden; }
    .chat-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; color: #000000; }
    .last-message {
      font-size: 14px;
      color: #666666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .last-message-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      fill: #666666;
    }
    .chat-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
    .timestamp { font-size: 12px; color: #8E8E8E; }
    .unread-count {
      background: #00AEEF; /* primary color */
      color: #FFFFFF;
      font-size: 12px;
      font-weight: 600;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
    }

    /* Empty State light mode */
    .empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 24px;
      text-align: center;
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s ease;
    }
    .empty-state.show {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .empty-icon { 
      width: 120px; 
      height: 120px; 
      margin-bottom: 32px; 
      opacity: 0.4; 
      font-size: 80px;
      color: #CCCCCC;
    }
    .empty-title { font-size: 20px; margin-bottom: 12px; color: #333333; }
    .empty-subtitle { font-size: 16px; color: #666666; line-height: 1.5; }

    /* Bottom nav light mode */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      height: 64px;
      background: #FFFFFF;
      border-top: 1px solid #E0E0E0;
      z-index: 100;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #666666;
      cursor: pointer;
      transition: color 0.2s;
    }
    .nav-item.active { color: #00FF00; } /* Active live tab green as per live page */
    .nav-item:hover { color: #333333; }
    .nav-item.active .nav-icon svg { fill: #00FF00; }
    .nav-item .nav-icon svg { fill: currentColor; }
    .nav-icon svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }

    /* FAB uses primary color */
    .fab {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 64px;
      height: 64px;
      background: #00AEEF;
      color: #000000;
      border-radius: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,174,239,0.3);
      cursor: pointer;
      z-index: 101;
      border: none;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .fab:hover { transform: translateX(-50%) scale(1.05); box-shadow: 0 6px 16px rgba(0,174,239,0.5); }
    .fab svg { width: 32px; height: 32px; fill: #000000; }

    /* Toast light mode with primary border */
    #toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      color: #000000;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 174, 239, 0.2);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 200;
      max-width: 90%;
      text-align: center;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(0,174,239,0.3);
    }
    #toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-8px);
    }

    /* Shimmer Loading - light mode with primary tint */
    .shimmer-wrapper {
      position: absolute;
      inset: 0;
      padding: 0 24px;
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.4s ease;
      z-index: 10;
    }
    .shimmer-wrapper.hidden { opacity: 0; visibility: hidden; }
    .shimmer-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      position: relative;
      overflow: hidden;
    }
    .shimmer-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -150%;
      width: 150%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(0, 174, 239, 0.1) 20%,
        rgba(0, 174, 239, 0.2) 50%,
        rgba(0, 174, 239, 0.1) 80%,
        transparent 100%
      );
      animation: shimmer 1.5s infinite linear;
    }
    .shimmer-photo { width: 56px; height: 56px; border-radius: 50%; background: #DDDDDD; margin-right: 16px; }
    .shimmer-details { flex: 1; }
    .shimmer-name { height: 16px; width: 50%; background: #DDDDDD; border-radius: 8px; margin-bottom: 8px; }
    .shimmer-msg { height: 14px; width: 70%; background: #DDDDDD; border-radius: 8px; }
    .shimmer-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
    .shimmer-time { height: 12px; width: 40px; background: #DDDDDD; border-radius: 8px; }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #00AEEF; /* primary color */
      font-style: italic;
    }
    .typing-dot {
      width: 4px;
      height: 4px;
      background: #00AEEF; /* primary color */
      border-radius: 50%;
      animation: typingPulse 1.5s infinite ease-in-out;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes shimmer {
      0% { left: -150%; }
      100% { left: 200%; }
    }

    @keyframes typingPulse {
      0%, 100% { opacity: 0.4; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-4px); }
    }

    /* Clear Search Button */
    .clear-search-btn {
      margin-top: 20px;
      padding: 10px 20px;
      background: #00AEEF; /* primary color */
      color: #000;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
    }
    .clear-search-btn:hover {
      background: #0099d0;
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
    }
    .loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #E0E0E0;
      border-top-color: #00AEEF; /* primary color */
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    .loading-text {
      color: #000000;
      font-size: 14px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <div class="search-bar">
      <div class="logo-small">
        <img src="asset/logo.png" alt="Coded Logo" width="40" height="40" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiNFMEUwRTAiLz48L3N2Zz4='">
      </div>
      <input type="text" class="search-input" id="search-input" placeholder="Search chats..." aria-label="Search chats">
    </div>
    <div class="header-icons"></div>
  </header>

  <div class="chat-list" id="chat-list">
    <!-- Shimmer skeleton (light mode) -->
    <div class="shimmer-wrapper" id="shimmer">
      <div class="shimmer-item">
        <div class="shimmer-photo"></div>
        <div class="shimmer-details">
          <div class="shimmer-name"></div>
          <div class="shimmer-msg"></div>
        </div>
        <div class="shimmer-meta">
          <div class="shimmer-time"></div>
        </div>
      </div>
      <div class="shimmer-item">
        <div class="shimmer-photo"></div>
        <div class="shimmer-details">
          <div class="shimmer-name"></div>
          <div class="shimmer-msg"></div>
        </div>
        <div class="shimmer-meta">
          <div class="shimmer-time"></div>
        </div>
      </div>
      <div class="shimmer-item">
        <div class="shimmer-photo"></div>
        <div class="shimmer-details">
          <div class="shimmer-name"></div>
          <div class="shimmer-msg"></div>
        </div>
        <div class="shimmer-meta">
          <div class="shimmer-time"></div>
        </div>
      </div>
      <div class="shimmer-item">
        <div class="shimmer-photo"></div>
        <div class="shimmer-details">
          <div class="shimmer-name"></div>
          <div class="shimmer-msg"></div>
        </div>
        <div class="shimmer-meta">
          <div class="shimmer-time"></div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="empty-state">
      <div class="empty-icon">ðŸ’¬</div>
      <div class="empty-title">No chats yet</div>
      <div class="empty-subtitle">Start a conversation to connect with others</div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loading-text">Loading...</div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-item" id="nav-live">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/></svg>
      </div>
      <div>Live</div>
    </div>
    <div class="nav-item" id="nav-favorites">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
      </div>
      <div>Favorites</div>
    </div>
    <div class="nav-item"></div>
    <div class="nav-item active" id="nav-chats">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>
      </div>
      <div>Chats</div>
    </div>
    <div class="nav-item" id="nav-profile">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      </div>
      <div>Profile</div>
    </div>

    <button class="fab" id="fab-post" aria-label="Post Request">
      <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </button>
  </div>

  <div id="toast"></div>

  <script>
    const fallbackImage = 'https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png';
    const API_BASE_URL = 'https://instaping.org/api';
    let currentUserId = null;
    let wsManager = null;
    let allChats = [];
    let customEventListeners = [];
    let loadedCount = 0;
    const visibleChats = 20;
    let typingTimeouts = new Map();

    // ==================== UTILITY FUNCTIONS ====================
    function showToast(message, duration = 2000) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        clearTimeout(toast.hideTimeout);
        toast.hideTimeout = setTimeout(() => toast.classList.remove('show'), duration);
    }

    function showLoading(message = 'Loading...') {
        const overlay = document.getElementById('loading-overlay');
        const text = document.getElementById('loading-text');
        text.textContent = message;
        overlay.classList.add('show');
    }

    function hideLoading() {
        const overlay = document.getElementById('loading-overlay');
        overlay.classList.remove('show');
    }

    function playNotificationSound() {
        try {
            const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
            audio.volume = 0.3;
            audio.play().catch(e => console.log('Audio play failed:', e));
        } catch (e) {
            console.log('Audio not supported');
        }
    }

    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            const payload = JSON.parse(jsonPayload);
            return payload.userId || payload.sub || payload.id || null;
        } catch (e) {
            console.error('Failed to parse JWT:', e);
            return null;
        }
    }

    function formatTimestamp(unix) {
        if (!unix) return '';
        const date = new Date(unix * 1000);
        const now = new Date();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);

        if (diffSec < 60) return 'Just now';
        if (diffSec < 3600) return Math.floor(diffSec / 60) + 'm';
        if (diffSec < 86400) return Math.floor(diffSec / 3600) + 'h';

        return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }

    function addCustomEventListener(element, event, handler) {
        element.addEventListener(event, handler);
        customEventListeners.push({ element, event, handler });
    }

    function cleanupEventListeners() {
        customEventListeners.forEach(({ element, event, handler }) => {
            element.removeEventListener(event, handler);
        });
        customEventListeners = [];
    }

    // ==================== WEBSOCKET MANAGER ====================
    class ChatWebSocketManager {
        constructor() {
            this.socket = null;
            this.reconnectInterval = 3000;
            this.maxReconnectAttempts = 5;
            this.reconnectAttempts = 0;
            this.isConnected = false;
            this.shouldReconnect = true;
            this.messageListeners = [];
            this.heartbeatInterval = 30000;
            this.heartbeatTimer = null;
        }

        connect() {
            if (this.socket?.readyState === WebSocket.OPEN) {
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                console.warn('No token found, WebSocket connection deferred');
                return;
            }

            const wsUrl = `ws://localhost:8080/ws?token=${encodeURIComponent(token)}`;
            console.log('Connecting to Chat WebSocket:', wsUrl);
            
            try {
                this.socket = new WebSocket(wsUrl);
                
                this.socket.onopen = () => {
                    console.log('Chat WebSocket connected');
                    this.isConnected = true;
                    this.reconnectAttempts = 0;
                    
                    // Start heartbeat
                    this.startHeartbeat();
                    
                    // Subscribe to chat updates
                    this.send({
                        type: 'subscribe',
                        channel: 'chat_updates'
                    });
                    
                    this.send({
                        type: 'subscribe',
                        channel: 'message_updates'
                    });
                    
                    showToast('ðŸ’¬ Live chat updates active');
                };

                this.socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('ðŸ“¨ Chat WebSocket message:', data);
                        this.handleMessage(data);
                        
                        // Notify all listeners
                        this.messageListeners.forEach(listener => listener(data));
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };

                this.socket.onclose = (event) => {
                    console.log('Chat WebSocket disconnected');
                    this.isConnected = false;
                    showToast('ðŸ”Œ Chat updates disconnected');
                    
                    if (this.heartbeatTimer) {
                        clearInterval(this.heartbeatTimer);
                        this.heartbeatTimer = null;
                    }
                    
                    if (this.shouldReconnect && this.reconnectAttempts < this.maxReconnectAttempts) {
                        setTimeout(() => this.reconnect(), this.reconnectInterval);
                    }
                };

                this.socket.onerror = (error) => {
                    console.error('Chat WebSocket error:', error);
                };

            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                setTimeout(() => this.reconnect(), this.reconnectInterval);
            }
        }

        startHeartbeat() {
            this.heartbeatTimer = setInterval(() => {
                if (this.socket?.readyState === WebSocket.OPEN) {
                    this.send({ type: 'ping' });
                }
            }, this.heartbeatInterval);
        }

        reconnect() {
            if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                console.error('Max reconnection attempts reached');
                return;
            }
            
            this.reconnectAttempts++;
            console.log(`ðŸ”„ Reconnecting attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}...`);
            this.connect();
        }

        send(data) {
            if (this.socket?.readyState === WebSocket.OPEN) {
                this.socket.send(JSON.stringify(data));
                return true;
            } else {
                console.warn('WebSocket not ready, retrying...');
                setTimeout(() => this.send(data), 1000);
                return false;
            }
        }

        handleMessage(data) {
            const { type, payload } = data;
            
            switch (type) {
                case 'new_message':
                    this.handleNewMessage(payload);
                    break;
                    
                case 'message_read':
                    this.handleMessageRead(payload);
                    break;
                    
                case 'typing_start':
                    this.handleTypingStart(payload);
                    break;
                    
                case 'typing_end':
                    this.handleTypingEnd(payload);
                    break;
                    
                case 'user_status_update':
                    this.handleUserStatusUpdate(payload);
                    break;
                    
                case 'chat_created':
                    this.handleChatCreated(payload);
                    break;
                    
                case 'pong':
                    console.log('â¤ï¸ WebSocket heartbeat received');
                    break;
                    
                default:
                    console.log('Unknown WebSocket message type:', type);
            }
        }

        handleNewMessage(message) {
            console.log('ðŸ†• New message received:', message);
            
            // Play notification sound if message is not from current user
            if (message.senderId !== currentUserId) {
                playNotificationSound();
                showToast(`ðŸ’¬ New message from ${message.sender?.name || 'Someone'}`);
            }
            
            // Update the chat list
            updateChatInList(message);
        }

        handleMessageRead(payload) {
            console.log('ðŸ“– Message read update:', payload);
            // Update read receipts in the UI
            updateReadReceipts(payload.chatId, payload.messageIds);
        }

        handleTypingStart(payload) {
            console.log('âœï¸ User typing:', payload);
            // Show typing indicator
            showTypingIndicator(payload.chatId, payload.userId);
            
            // Auto-hide typing indicator after 3 seconds (in case typing_end doesn't arrive)
            if (typingTimeouts.has(payload.chatId)) {
                clearTimeout(typingTimeouts.get(payload.chatId));
            }
            typingTimeouts.set(payload.chatId, setTimeout(() => {
                hideTypingIndicator(payload.chatId);
            }, 3000));
        }

        handleTypingEnd(payload) {
            console.log('â¹ï¸ User stopped typing:', payload);
            // Hide typing indicator
            hideTypingIndicator(payload.chatId);
            
            // Clear timeout
            if (typingTimeouts.has(payload.chatId)) {
                clearTimeout(typingTimeouts.get(payload.chatId));
                typingTimeouts.delete(payload.chatId);
            }
        }

        handleUserStatusUpdate(payload) {
            console.log('ðŸ“Š User status updated:', payload);
            // Update online status in chat list
            updateUserStatus(payload.userId, payload.status);
        }

        handleChatCreated(payload) {
            console.log('ðŸ’¬ New chat created:', payload);
            // Add new chat to the list
            addNewChat(payload);
        }

        disconnect() {
            this.shouldReconnect = false;
            if (this.heartbeatTimer) {
                clearInterval(this.heartbeatTimer);
                this.heartbeatTimer = null;
            }
            if (this.socket) {
                this.socket.close();
                this.socket = null;
            }
            this.isConnected = false;
        }

        sendTypingStart(chatId) {
            this.send({
                type: 'typing_start',
                payload: { chatId }
            });
        }

        sendTypingEnd(chatId) {
            this.send({
                type: 'typing_end', 
                payload: { chatId }
            });
        }

        sendMessageRead(chatId, messageIds) {
            this.send({
                type: 'message_read',
                payload: { chatId, messageIds }
            });
        }
        
        addMessageListener(listener) {
            this.messageListeners.push(listener);
        }
        
        removeMessageListener(listener) {
            const index = this.messageListeners.indexOf(listener);
            if (index > -1) {
                this.messageListeners.splice(index, 1);
            }
        }
    }

    // ==================== UI UPDATE FUNCTIONS ====================
    function updateChatInList(message) {
        console.log('ðŸ”„ updateChatInList called for chat:', message.chatId);
        
        const chatListEl = document.getElementById('chat-list');
        const emptyStateEl = document.getElementById('empty-state');
        
        // Check if chat exists
        let chatItem = chatListEl.querySelector(`[data-chat-id="${message.chatId}"]`);
        
        if (chatItem) {
            console.log('âœ… Chat found, updating...');
            
            // Move chat to top
            chatListEl.insertBefore(chatItem, chatListEl.firstChild);
            
            // Update last message preview
            const lastMessageEl = chatItem.querySelector('.last-message');
            if (lastMessageEl) {
                let preview = message.content || '';
                let previewIcon = '';
                
                // Determine message type
                if (message.type === 'image' || (message.content && (message.content.includes('res.cloudinary.com') || message.content.includes('image') || message.content.includes('photo')))) {
                    preview = 'Photo';
                    previewIcon = '<svg class="last-message-icon" viewBox="0 0 24 24" style="display:inline-block;width:16px;height:16px;margin-right:4px;vertical-align:middle"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>';
                } else if (message.type === 'voice' || message.type === 'audio') {
                    preview = 'Voice message';
                    previewIcon = '<svg class="last-message-icon" viewBox="0 0 24 24" style="display:inline-block;width:16px;height:16px;margin-right:4px;vertical-align:middle"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>';
                } else {
                    preview = message.content || 'Message';
                }
                
                lastMessageEl.innerHTML = `
                    ${previewIcon}
                    ${preview.length > 30 ? preview.substring(0, 30) + '...' : preview}
                `;
            }
            
            // Update timestamp
            const timestampEl = chatItem.querySelector('.timestamp');
            if (timestampEl) {
                timestampEl.textContent = formatTimestamp(message.createdAt || Math.floor(Date.now() / 1000));
            }
            
            // Update unread count if message is not from current user
            if (message.senderId !== currentUserId) {
                const unreadCountEl = chatItem.querySelector('.unread-count');
                if (unreadCountEl) {
                    const currentCount = parseInt(unreadCountEl.textContent) || 0;
                    unreadCountEl.textContent = currentCount + 1;
                } else {
                    const chatMeta = chatItem.querySelector('.chat-meta');
                    if (chatMeta) {
                        chatMeta.innerHTML = `
                            <div class="timestamp">${formatTimestamp(message.createdAt)}</div>
                            <div class="unread-count">1</div>
                        `;
                    }
                }
            } else {
                // If message is from current user, clear unread count
                const unreadCountEl = chatItem.querySelector('.unread-count');
                if (unreadCountEl) {
                    unreadCountEl.remove();
                }
            }
            
        } else {
            console.log('âŒ Chat not found in list, reloading chats...');
            // Chat not in list, reload all chats
            loadChats();
        }
    }

    function updateReadReceipts(chatId, messageIds) {
        const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
        if (chatItem) {
            const unreadCountEl = chatItem.querySelector('.unread-count');
            if (unreadCountEl) {
                unreadCountEl.remove();
            }
        }
    }

    function updateUserStatus(userId, status) {
        const chatItems = document.querySelectorAll(`[data-user-id="${userId}"]`);
        chatItems.forEach(item => {
            const onlineDot = item.querySelector('.online-dot');
            if (onlineDot) {
                onlineDot.style.display = status === 'offline' ? 'none' : 'block';
                onlineDot.classList.remove('busy', 'away');
                if (status === 'available') {
                    onlineDot.style.backgroundColor = '#00AEEF';
                } else if (status === 'busy') {
                    onlineDot.style.backgroundColor = '#FFFF00';
                    onlineDot.classList.add('busy');
                } else if (status === 'away') {
                    onlineDot.style.backgroundColor = '#FF0000';
                    onlineDot.classList.add('away');
                }
            }
        });
    }

    function showTypingIndicator(chatId, userId) {
        const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
        if (chatItem && userId !== currentUserId) {
            const lastMessageEl = chatItem.querySelector('.last-message');
            if (lastMessageEl) {
                lastMessageEl.innerHTML = `
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <span>typing...</span>
                    </div>
                `;
            }
        }
    }

    function hideTypingIndicator(chatId) {
        const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
        if (chatItem) {
            // Find the chat in allChats to restore the last message
            const chat = allChats.find(c => c.id === chatId);
            if (chat && chat.lastMessage) {
                const lastMessageEl = chatItem.querySelector('.last-message');
                if (lastMessageEl) {
                    let preview = chat.lastMessage.content || '';
                    let previewIcon = '';
                    
                    if (chat.lastMessage.type === 'image') {
                        preview = 'Photo';
                        previewIcon = '<svg class="last-message-icon" viewBox="0 0 24 24" style="display:inline-block;width:16px;height:16px;margin-right:4px;vertical-align:middle"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>';
                    }
                    
                    lastMessageEl.innerHTML = `
                        ${previewIcon}
                        ${preview.length > 30 ? preview.substring(0, 30) + '...' : preview}
                    `;
                }
            }
        }
    }

    function addNewChat(chatData) {
        console.log('âž• Adding new chat to list:', chatData.id);
        
        const chatListEl = document.getElementById('chat-list');
        const emptyStateEl = document.getElementById('empty-state');
        
        // Hide empty state if showing
        if (emptyStateEl.classList.contains('show')) {
            emptyStateEl.classList.remove('show');
        }
        
        // Check if chat already exists
        if (document.querySelector(`[data-chat-id="${chatData.id}"]`)) {
            console.log('Chat already exists, skipping...');
            return;
        }
        
        // Add new chat to the top
        const partner = chatData.partner || { name: 'Unknown', avatar: fallbackImage, status: 'offline' };
        const isOnline = partner.status === 'available';
        const isBusy = partner.status === 'busy';
        const isAway = partner.status === 'away';
        
        const item = document.createElement('div');
        item.className = 'chat-item';
        item.dataset.chatId = chatData.id;
        item.dataset.userId = partner.id || '';
        item.setAttribute('role', 'button');
        item.setAttribute('tabindex', '0');
        item.setAttribute('aria-label', `Chat with ${partner.name || 'Unknown'}. No unread messages`);
        item.innerHTML = `
            <div class="profile-photo">
                <img src="${partner.avatar || fallbackImage}" alt="${partner.name}" onerror="this.src='${fallbackImage}'">
                ${isOnline || isBusy || isAway ? 
                    `<div class="online-dot ${isBusy ? 'busy' : ''} ${isAway ? 'away' : ''}"></div>` : ''}
            </div>
            <div class="chat-details">
                <div class="chat-name">${partner.name || 'Unknown'}</div>
                <div class="last-message">
                    <svg class="last-message-icon" viewBox="0 0 24 24" style="display:inline-block;width:16px;height:16px;margin-right:4px;vertical-align:middle">
                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                    </svg>
                    Start the conversation
                </div>
            </div>
            <div class="chat-meta">
                <div class="timestamp">Just now</div>
            </div>
        `;
        
        // Add click handler
        addCustomEventListener(item, 'click', () => {
            window.location.href = `chat.html?id=${chatData.id}`;
        });
        
        // Add keyboard support
        addCustomEventListener(item, 'keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                window.location.href = `chat.html?id=${chatData.id}`;
            }
        });
        
        // Insert at top
        if (chatListEl.firstChild) {
            chatListEl.insertBefore(item, chatListEl.firstChild);
        } else {
            chatListEl.appendChild(item);
        }
        
        // Add to allChats array
        allChats.unshift(chatData);
        
        console.log('âœ… New chat added to list');
    }

    // ==================== CHAT RENDERING ====================
    function renderChats(chats, append = false) {
        console.log('ðŸŽ¨ Rendering chats:', chats.length, 'append:', append);
        
        const chatListEl = document.getElementById('chat-list');
        const emptyStateEl = document.getElementById('empty-state');

        if (!append) {
            loadedCount = 0;
            // Clear existing chats (except shimmer which is already hidden)
            const existingChats = chatListEl.querySelectorAll('.chat-item');
            existingChats.forEach(chat => chat.remove());
        }

        if (chats.length === 0 && !append) {
            emptyStateEl.classList.add('show');
            emptyStateEl.querySelector('.empty-title').textContent = 'No chats yet';
            emptyStateEl.querySelector('.empty-subtitle').textContent = 'Start a conversation to connect with others';
            return;
        }

        if (!append) {
            emptyStateEl.classList.remove('show');
        }

        // Sort chats by lastMessageAt (newest first)
        const chatsToRender = [...chats].sort((a, b) => (b.lastMessageAt || 0) - (a.lastMessageAt || 0));
        const chatsToShow = chatsToRender.slice(loadedCount, loadedCount + visibleChats);

        chatsToShow.forEach((chat, index) => {
            const partner = chat.partner || { name: 'Unknown', avatar: fallbackImage, status: 'offline' };
            const isOnline = partner.status === 'available';
            const isBusy = partner.status === 'busy';
            const isAway = partner.status === 'away';

            let lastPreview = 'No messages yet';
            let previewIcon = '';

            if (chat.lastMessage) {
                const msg = chat.lastMessage;

                if (typeof msg === 'object' && msg.type === 'image') {
                    lastPreview = 'Photo';
                    previewIcon = '<svg class="last-message-icon" viewBox="0 0 24 24" style="display:inline-block;width:16px;height:16px;margin-right:4px;vertical-align:middle"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>';
                } else if (typeof msg === 'object' && msg.type === 'text' && msg.content) {
                    lastPreview = msg.content;
                } else if (typeof msg === 'string') {
                    if (msg.trim() === '') {
                        lastPreview = 'No messages yet';
                    } else if (msg.includes('res.cloudinary.com') || msg.includes('image') || msg.includes('photo')) {
                        lastPreview = 'Photo';
                        previewIcon = '<svg class="last-message-icon" viewBox="0 0 24 24" style="display:inline-block;width:16px;height:16px;margin-right:4px;vertical-align:middle"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>';
                    } else {
                        lastPreview = msg.trim();
                    }
                }
            }

            // Truncate long messages
            if (lastPreview.length > 30) {
                lastPreview = lastPreview.substring(0, 30) + '...';
            }

            const unreadCount = chat.unreadCount || 0;
            const unreadBadge = unreadCount > 0 
                ? `<div class="unread-count">${unreadCount > 99 ? '99+' : unreadCount}</div>` 
                : '';

            const item = document.createElement('div');
            item.className = 'chat-item';
            item.dataset.chatId = chat.id;
            item.dataset.userId = partner.id || '';
            item.setAttribute('role', 'button');
            item.setAttribute('tabindex', '0');
            item.setAttribute('aria-label', `Chat with ${partner.name || 'Unknown'}. ${unreadCount > 0 ? `${unreadCount} unread messages` : 'No unread messages'}. Last message: ${lastPreview}`);
            item.innerHTML = `
                <div class="profile-photo">
                    <img src="${partner.avatar || fallbackImage}" alt="${partner.name}" onerror="this.src='${fallbackImage}'">
                    ${isOnline || isBusy || isAway ? 
                        `<div class="online-dot ${isBusy ? 'busy' : ''} ${isAway ? 'away' : ''}"></div>` : ''}
                </div>
                <div class="chat-details">
                    <div class="chat-name">${partner.name || 'Unknown'}</div>
                    <div class="last-message">
                        ${previewIcon}
                        ${lastPreview}
                    </div>
                </div>
                <div class="chat-meta">
                    <div class="timestamp">${formatTimestamp(chat.lastMessageAt)}</div>
                    ${unreadBadge}
                </div>
            `;
            
            // Add click handler
            addCustomEventListener(item, 'click', () => {
                console.log('Opening chat:', chat.id);
                window.location.href = `chat.html?id=${chat.id}`;
            });
            
            // Add keyboard support
            addCustomEventListener(item, 'keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    window.location.href = `chat.html?id=${chat.id}`;
                }
            });
            
            chatListEl.appendChild(item);
        });
        
        loadedCount += chatsToShow.length;
        
        // Add infinite scroll listener if not already added
        if (!window.chatScrollHandler) {
            window.chatScrollHandler = () => {
                if (chatListEl.scrollTop + chatListEl.clientHeight >= chatListEl.scrollHeight - 100) {
                    if (loadedCount < chats.length) {
                        renderChats(chats, true);
                    }
                }
            };
            addCustomEventListener(chatListEl, 'scroll', window.chatScrollHandler);
        }
        
        console.log(`âœ… ${chatsToShow.length} chats rendered (total loaded: ${loadedCount}/${chats.length})`);
    }

    // ==================== MAIN LOADING FUNCTION ====================
    async function loadChats() {
        const chatListEl = document.getElementById('chat-list');
        const emptyStateEl = document.getElementById('empty-state');
        const shimmerEl = document.getElementById('shimmer');

        // Get token from localStorage
        const token = localStorage.getItem('token');
        
        if (!token) {
            showToast('Please log in first.');
            setTimeout(() => window.location.href = 'login.html', 1500);
            return;
        }

        // Show shimmer, hide empty state
        shimmerEl.classList.remove('hidden');
        emptyStateEl.classList.remove('show');

        try {
            console.log('ðŸ“¡ Loading chats from API...');
            const res = await fetch(`${API_BASE_URL}/chats`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!res.ok) {
                if (res.status === 401) {
                    // Token expired or invalid
                    showToast('Session expired. Please log in again.');
                    localStorage.removeItem('token');
                    setTimeout(() => window.location.href = 'login.html', 1500);
                    return;
                }
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            
            const data = await res.json();
            allChats = Array.isArray(data) ? data : [];
            console.log(`âœ… ${allChats.length} chats loaded`);

            // Hide shimmer
            shimmerEl.classList.add('hidden');
            renderChats(allChats);
        } catch (err) {
            console.error('âŒ Chats load error:', err);
            
            // Specific error messages
            if (err.message.includes('Failed to fetch')) {
                showToast('Network error. Check your internet connection.');
            } else if (err.message.includes('401')) {
                showToast('Session expired. Please log in again.');
                localStorage.removeItem('token');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            } else {
                showToast('Failed to load chats');
            }
            
            shimmerEl.classList.add('hidden');
            emptyStateEl.classList.add('show');
            emptyStateEl.querySelector('.empty-title').textContent = 'Failed to load';
            emptyStateEl.querySelector('.empty-subtitle').innerHTML = `
                Check your connection and try again<br>
                <button class="clear-search-btn" onclick="location.reload()">Retry</button>
            `;
        }
    }

    // ==================== SEARCH FUNCTION ====================
    function setupSearch() {
        const searchInput = document.getElementById('search-input');
        
        addCustomEventListener(searchInput, 'input', () => {
            const query = searchInput.value.toLowerCase().trim();

            if (query === '') {
                renderChats(allChats);
                return;
            }

            const filtered = allChats.filter(chat => {
                const partner = chat.partner || {};
                const name = (partner.name || '').toLowerCase();
                const lastMessage = chat.lastMessage?.content || '';
                const lastMessageStr = typeof lastMessage === 'string' ? lastMessage.toLowerCase() : '';
                const chatId = chat.id || '';
                
                return name.includes(query) || 
                       lastMessageStr.includes(query) ||
                       chatId.includes(query);
            });

            renderChats(filtered);

            if (filtered.length === 0) {
                const emptyStateEl = document.getElementById('empty-state');
                emptyStateEl.classList.add('show');
                emptyStateEl.querySelector('.empty-title').textContent = 'No results found';
                emptyStateEl.querySelector('.empty-subtitle').innerHTML = 
                    `No chats match "${query}"<br>
                     <button class="clear-search-btn" onclick="document.getElementById('search-input').value='';loadChats()">
                         Clear Search
                     </button>`;
            }
        });
    }

    // ==================== KEYBOARD NAVIGATION ====================
    function setupKeyboardNavigation() {
        addCustomEventListener(document, 'keydown', (e) => {
            const chatItems = document.querySelectorAll('.chat-item');
            const activeElement = document.activeElement;
            
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                e.preventDefault();
                const currentIndex = Array.from(chatItems).indexOf(activeElement);
                let nextIndex;
                
                if (e.key === 'ArrowDown') {
                    nextIndex = currentIndex < chatItems.length - 1 ? currentIndex + 1 : 0;
                } else {
                    nextIndex = currentIndex > 0 ? currentIndex - 1 : chatItems.length - 1;
                }
                
                if (chatItems[nextIndex]) {
                    chatItems[nextIndex].focus();
                }
            } else if ((e.key === 'Enter' || e.key === ' ') && activeElement.classList.contains('chat-item')) {
                e.preventDefault();
                activeElement.click();
            }
        });
    }

    // ==================== NAVIGATION SETUP ====================
    function setupNavigation() {
        const navItems = {
            'nav-live': 'live-requests.html',
            'nav-favorites': 'favorites.html',
            'nav-chats': () => window.location.reload(),
            'nav-profile': 'my-profile.html',
            'fab-post': 'post.html'
        };

        Object.entries(navItems).forEach(([id, target]) => {
            const element = document.getElementById(id);
            if (element) {
                addCustomEventListener(element, 'click', () => {
                    if (typeof target === 'function') {
                        target();
                    } else {
                        window.location.href = target;
                    }
                });
            }
        });
    }

    // ==================== INITIALIZATION ====================
    (function() {
        console.log('ðŸš€ Initializing chats page...');
        
        const token = localStorage.getItem('token');
        if (!token) {
            showToast('Please log in first.');
            setTimeout(() => window.location.href = 'login.html', 1500);
            return;
        }

        currentUserId = parseJwt(token);
        if (!currentUserId) {
            showToast('Invalid session. Please log in again.');
            localStorage.removeItem('token');
            setTimeout(() => window.location.href = 'login.html', 1500);
            return;
        }

        console.log('ðŸ‘¤ Current user ID:', currentUserId);

        // Setup components
        setupSearch();
        setupKeyboardNavigation();
        setupNavigation();

        // Initialize WebSocket manager
        wsManager = new ChatWebSocketManager();

        // Load chats
        loadChats();
        
        // Start WebSocket connection
        setTimeout(() => {
            console.log('ðŸ”Œ Starting WebSocket connection...');
            wsManager.connect();
            
            // Add direct message listener
            wsManager.addMessageListener((data) => {
                console.log('ðŸ“¨ WebSocket listener received:', data.type);
                if (data.type === 'new_message') {
                    console.log('ðŸ’¬ Direct listener handling new message:', data.payload.chatId);
                    updateChatInList(data.payload);
                }
            });
        }, 1000);

        // Auto-refresh every 60 seconds as backup
        setInterval(() => {
            if (!wsManager.isConnected) {
                console.log('ðŸ”„ Auto-refreshing chats (WebSocket disconnected)');
                loadChats();
            }
        }, 60000);

        // Add manual refresh button handler (if exists)
        const refreshBtn = document.querySelector('.refresh-btn');
        if (refreshBtn) {
            addCustomEventListener(refreshBtn, 'click', () => {
                console.log('Manual refresh triggered');
                loadChats();
            });
        }

        // Clean up on page unload
        addCustomEventListener(window, 'beforeunload', () => {
            cleanupEventListeners();
            if (wsManager) {
                wsManager.disconnect();
            }
        });

        // Force WebSocket to handle new messages by adding a global function
        window.handleNewMessage = function(message) {
            console.log('ðŸŒ Global handler called for message:', message.chatId);
            updateChatInList(message);
        };

        console.log('âœ… Chats page initialization complete');
    })();
  </script>
</body>
</html>