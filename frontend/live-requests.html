<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InstaPing | Live Requests</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <link rel="icon" type="image/png" href="asset/logo.jpeg">
  <link rel="icon" type="image/jpeg" href="asset/logo.jpeg">
  <link rel="apple-touch-icon" href="/asset/logo.jpeg">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000000; color: #FFFFFF; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }

    /* Desktop/PC message overlay */
    .desktop-message {
      position: fixed;
      inset: 0;
      background: #000000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 24px;
      z-index: 1000;
    }
    .desktop-message .icon {
      width: 120px;
      height: 120px;
      margin-bottom: 32px;
      opacity: 0.6;
    }
    .desktop-message h1 {
      font-size: 28px;
      margin-bottom: 16px;
    }
    .desktop-message p {
      font-size: 18px;
      color: #CCCCCC;
      max-width: 600px;
      line-height: 1.5;
    }

    /* Default: hide the app and show message on large screens */
    .desktop-message { display: flex; }
    header, .feed, .bottom-nav, #toast { display: none; }

    /* Show app on real touch devices (phones & tablets) */
    @media (hover: none) or (pointer: coarse) {
      .desktop-message { display: none; }
      header, .feed, .bottom-nav, #toast { display: block; }
    }

    /* Force show app when viewport is small (DevTools mobile view or resized window on PC) */
    @media (max-width: 1023px) {
      .desktop-message { display: none; }
      header, .feed, .bottom-nav, #toast { display: block; }
    }

    /* Override for bottom-nav to keep flex layout */
    .bottom-nav { display: flex; }

    header { position: fixed; top: 0; left: 0; right: 0; display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: #000000; border-bottom: 1px solid #2A2A2A; z-index: 100; }
    .logo-small { width: 40px; height: 40px; }
    .logo-small img { width: 100%; height: 100%; object-fit: contain; }
    .status-indicator { padding: 8px 16px; background: #1F1F1F; border: 1px solid #2A2A2A; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .status-indicator svg { width: 12px; height: 12px; }
    .status-available svg { fill: #00FF00; }
    .status-busy svg { fill: #FFFF00; }
    .status-offline svg { fill: #FF0000; }
    .feed { flex: 1; overflow-y: auto; padding: 16px 24px 80px; padding-top: 80px; position: relative; }
    .request-card { background: #1F1F1F; border-radius: 16px; padding: 20px; margin-bottom: 20px; display: flex; flex-direction: column; }
    .card-header { display: flex; align-items: center; margin-bottom: 12px; cursor: pointer; }
    .profile-photo { width: 64px; height: 64px; border-radius: 50%; overflow: hidden; margin-right: 16px; background: #2A2A2A; }
    .profile-photo img { width: 100%; height: 100%; object-fit: cover; }
    .user-info { flex: 1; }
    .name-age { font-size: 18px; font-weight: 600; }
    .distance { font-size: 14px; color: #8E8E8E; }
    .category { font-size: 14px; color: #FFFFFF; background: #2A2A2A; padding: 4px 12px; border-radius: 16px; align-self: flex-start; margin-bottom: 8px; }
    .request-text { font-size: 16px; margin-bottom: 12px; line-height: 1.4; }
    .card-footer { display: flex; justify-content: space-between; align-items: center; }
    .time-rating { font-size: 14px; color: #8E8E8E; display: flex; align-items: center; gap: 8px; }
    .time-rating svg { width: 16px; height: 16px; fill: #FFD700; }
    .actions { display: flex; gap: 12px; position: relative; }
    .action-btn { width: 48px; height: 48px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; background: transparent; }
    .action-btn svg { width: 24px; height: 24px; fill: #FFFFFF; transition: fill 0.4s ease, transform 0.4s ease; }
    .action-btn.favorite svg { fill: #FFFFFF; }
    .action-btn.favorite.favorited svg { fill: #FF0000; }
    .action-btn.favorite.animate svg { animation: heartPulse 0.6s ease; }
    @keyframes heartPulse { 0% { transform: scale(1); } 20% { transform: scale(1.4); } 40% { transform: scale(1.1); } 60% { transform: scale(1.4); } 100% { transform: scale(1); } }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 64px; background: #1F1F1F; border-top: 1px solid #2A2A2A; z-index: 100; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; color: #8E8E8E; cursor: pointer; }
    .nav-item.active { color: #FFFFFF; }
    .nav-icon svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
    .fab { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 64px; height: 64px; background: #FFFFFF; color: #000000; border-radius: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.5); cursor: pointer; z-index: 101; }
    .fab svg { width: 32px; height: 32px; fill: currentColor; }
    .no-requests { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #8E8E8E; font-size: 18px; width: 100%; padding: 0 24px; }
    .no-requests-icon { width: 96px; height: 96px; margin: 0 auto 24px; opacity: 0.4; }
    .no-requests h3 { font-size: 20px; margin-bottom: 12px; }
    .no-requests p { font-size: 16px; line-height: 1.5; }
    @keyframes confettiFall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(80px) rotate(720deg); opacity: 0; } }
    .confetti-piece { position: absolute; width: 6px; height: 12px; pointer-events: none; animation: confettiFall 1s ease-out forwards; z-index: 10; }
    #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(31, 31, 31, 0.95); color: #FFFFFF; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease; z-index: 200; max-width: 90%; text-align: center; backdrop-filter: blur(8px); }
    #toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-8px); }

    /* === ENHANCED SHIMMER LOADING === */
    .shimmer-wrapper {
      position: absolute;
      inset: 0;
      padding: 16px 24px;
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.3s ease;
      z-index: 10;
    }
    
    .shimmer-wrapper.hidden {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .shimmer-card {
      background: #1a1a1a;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
      border: 1px solid #2A2A2A;
    }
    
    /* Shimmer effect */
    .shimmer-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -150%;
      width: 150%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.05) 20%,
        rgba(255, 255, 255, 0.1) 50%,
        rgba(255, 255, 255, 0.05) 80%,
        transparent 100%
      );
      animation: shimmer 1.5s infinite linear;
    }
    
    .shimmer-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
    }
    
    .shimmer-photo {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #2A2A2A;
      margin-right: 16px;
      position: relative;
      overflow: hidden;
    }
    
    .shimmer-photo::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.08) 50%,
        transparent 100%
      );
      animation: shimmer 2s infinite linear;
      animation-delay: 0.3s;
    }
    
    .shimmer-lines {
      flex: 1;
      position: relative;
      z-index: 1;
    }
    
    .shimmer-line {
      height: 18px;
      background: #2A2A2A;
      border-radius: 8px;
      margin-bottom: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .shimmer-line::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.08) 50%,
        transparent 100%
      );
      animation: shimmer 2s infinite linear;
    }
    
    .shimmer-line.short {
      width: 60%;
    }
    
    .shimmer-line:nth-child(2)::after {
      animation-delay: 0.2s;
    }
    
    .shimmer-category {
      height: 24px;
      width: 100px;
      background: #2A2A2A;
      border-radius: 16px;
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }
    
    .shimmer-category::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.08) 50%,
        transparent 100%
      );
      animation: shimmer 2.5s infinite linear;
      animation-delay: 0.4s;
    }
    
    .shimmer-text {
      height: 16px;
      background: #2A2A2A;
      border-radius: 8px;
      margin-bottom: 8px;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }
    
    .shimmer-text::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.08) 50%,
        transparent 100%
      );
      animation: shimmer 2s infinite linear;
    }
    
    .shimmer-text.long {
      width: 100%;
    }
    
    .shimmer-text.medium {
      width: 80%;
    }
    
    .shimmer-text:nth-child(2)::after {
      animation-delay: 0.1s;
    }
    
    .shimmer-text:nth-child(3)::after {
      animation-delay: 0.2s;
    }
    
    .shimmer-text:nth-child(4)::after {
      animation-delay: 0.3s;
    }
    
    .shimmer-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      position: relative;
      z-index: 1;
    }
    
    .shimmer-time {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .shimmer-time-icon {
      width: 16px;
      height: 16px;
      background: #2A2A2A;
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }
    
    .shimmer-time-icon::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.08) 50%,
        transparent 100%
      );
      animation: shimmer 2s infinite linear;
      animation-delay: 0.5s;
    }
    
    .shimmer-time-text {
      width: 80px;
      height: 14px;
      background: #2A2A2A;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .shimmer-time-text::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.08) 50%,
        transparent 100%
      );
      animation: shimmer 2s infinite linear;
      animation-delay: 0.6s;
    }
    
    .shimmer-actions {
      display: flex;
      gap: 12px;
    }
    
    .shimmer-btn {
      width: 48px;
      height: 48px;
      background: #2A2A2A;
      border-radius: 50%;
      position: relative;
      overflow: hidden;
    }
    
    .shimmer-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.08) 50%,
        transparent 100%
      );
      animation: shimmer 2s infinite linear;
    }
    
    .shimmer-btn:nth-child(2)::after {
      animation-delay: 0.2s;
    }
    
    .shimmer-btn:nth-child(3)::after {
      animation-delay: 0.4s;
    }
    
    @keyframes shimmer {
      0% {
        left: -100%;
      }
      100% {
        left: 200%;
      }
    }
    
    /* Stagger animation for cards */
    .shimmer-card:nth-child(1)::before {
      animation-delay: 0.1s;
    }
    
    .shimmer-card:nth-child(2)::before {
      animation-delay: 0.2s;
    }
    
    .shimmer-card:nth-child(3)::before {
      animation-delay: 0.3s;
    }
    
    .shimmer-card:nth-child(4)::before {
      animation-delay: 0.4s;
    }

    /* === ANIMATED LOCATION PIN FLOATING BUTTON === */
    .location-fab {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: #FFFFFF;
      color: #000000;
      border-radius: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 20px rgba(255, 255, 255, 0.3);
      cursor: pointer;
      z-index: 102;
      transition: all 0.3s ease;
      border: none;
    }

    .location-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(255, 255, 255, 0.4);
    }

    .location-fab:active {
      transform: scale(0.95);
    }

    .location-fab svg {
      width: 28px;
      height: 28px;
      fill: #000000;
      animation: location-pulse 2s infinite;
    }

    .location-fab .badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #FF0000;
      color: white;
      font-size: 11px;
      font-weight: bold;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: badge-pulse 1.5s infinite;
      z-index: 1;
    }

    @keyframes location-pulse {
      0%, 100% {
        transform: scale(1);
        fill: #000000;
      }
      50% {
        transform: scale(1.1);
        fill: #FF0000;
      }
    }

    @keyframes badge-pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    /* Broadcast Radar Scanning Overlay */
    .broadcast-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 999;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      backdrop-filter: blur(5px);
      overflow-y: auto;
      padding: 20px;
    }

    .broadcast-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .broadcast-container {
      position: relative;
      width: 300px;
      height: 300px;
      margin-bottom: 40px;
      transition: all 0.5s ease;
    }

    .broadcast-container.hidden {
      opacity: 0;
      height: 0;
      margin-bottom: 0;
      overflow: hidden;
    }

    /* Broadcast center with pulsing circles */
    .broadcast-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 30px;
      height: 30px;
      background: #FFFFFF;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
      z-index: 3;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .broadcast-center svg {
      width: 18px;
      height: 18px;
      fill: #000000;
    }

    /* Pulsing broadcast waves */
    .broadcast-wave {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 100px;
      border: 2px solid #FFFFFF;
      border-radius: 50%;
      opacity: 0;
      animation: broadcast-wave 2s ease-out infinite;
    }

    .broadcast-wave:nth-child(2) {
      animation-delay: 0.5s;
      width: 200px;
      height: 200px;
      border-width: 1.5px;
    }

    .broadcast-wave:nth-child(3) {
      animation-delay: 1s;
      width: 300px;
      height: 300px;
      border-width: 1px;
    }

    /* Broadcast signal lines */
    .broadcast-signal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 350px;
      height: 350px;
      transition: opacity 0.3s ease;
    }

    .signal-line {
      position: absolute;
      width: 2px;
      height: 100%;
      background: linear-gradient(to bottom, transparent 0%, #FFFFFF 15%, transparent 30%);
      left: 50%;
      transform-origin: center;
      opacity: 0.3;
    }

    .signal-line:nth-child(1) { transform: rotate(0deg); }
    .signal-line:nth-child(2) { transform: rotate(45deg); }
    .signal-line:nth-child(3) { transform: rotate(90deg); }
    .signal-line:nth-child(4) { transform: rotate(135deg); }

    /* Detected user dots */
    .broadcast-dot {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #FF0000;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 10px #FF0000;
      animation: dot-pulse 1.5s infinite;
      z-index: 2;
    }

    /* Broadcast text */
    .broadcast-text {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #FFFFFF;
      text-align: center;
      font-family: inherit;
      min-height: 28px;
    }

    .broadcast-subtext {
      font-size: 16px;
      color: #8E8E8E;
      text-align: center;
      margin-bottom: 32px;
      font-family: inherit;
      min-height: 20px;
    }

    .broadcast-results {
      width: 100%;
      max-width: 400px;
      display: none;
      flex-direction: column;
      gap: 12px;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 5px;
    }

    .broadcast-results.active {
      display: flex;
      animation: slideIn 0.5s ease;
    }

    .broadcast-result-item {
      background: #1F1F1F;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      animation: slideUp 0.3s ease;
      border: 1px solid #2A2A2A;
      font-family: inherit;
      transition: transform 0.2s ease;
    }

    .broadcast-result-item:hover {
      transform: translateY(-2px);
      border-color: #FFFFFF;
    }

    .broadcast-result-item .profile-photo {
      width: 48px;
      height: 48px;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .broadcast-result-info {
      flex: 1;
      overflow: hidden;
    }

    .broadcast-result-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      font-family: inherit;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .broadcast-result-distance {
      font-size: 14px;
      color: #8E8E8E;
      font-family: inherit;
    }

    .broadcast-result-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .broadcast-result-action {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #2A2A2A;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s ease;
      font-family: inherit;
    }

    .broadcast-result-action:hover {
      background: #3A3A3A;
    }

    .broadcast-result-action svg {
      width: 18px;
      height: 18px;
      fill: #FFFFFF;
    }

    .broadcast-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: #1F1F1F;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 1px solid #2A2A2A;
      font-family: inherit;
      transition: background 0.2s ease;
    }

    .broadcast-close:hover {
      background: #2A2A2A;
    }

    .broadcast-close svg {
      width: 24px;
      height: 24px;
      fill: #FFFFFF;
    }

    /* Animations */
    @keyframes broadcast-wave {
      0% {
        transform: translate(-50%, -50%) scale(0.3);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0;
      }
    }

    @keyframes dot-pulse {
      0%, 100% {
        opacity: 0.3;
        transform: translate(-50%, -50%) scale(0.8);
      }
      50% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.2);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      .broadcast-container {
        width: 250px;
        height: 250px;
      }
      
      .broadcast-wave:nth-child(1) {
        width: 83px;
        height: 83px;
      }
      
      .broadcast-wave:nth-child(2) {
        width: 166px;
        height: 166px;
      }
      
      .broadcast-wave:nth-child(3) {
        width: 250px;
        height: 250px;
      }
      
      .broadcast-signal {
        width: 290px;
        height: 290px;
      }
      
      .broadcast-results {
        max-height: 50vh;
      }
    }

    /* Scrollbar styling for results */
    .broadcast-results::-webkit-scrollbar {
      width: 4px;
    }

    .broadcast-results::-webkit-scrollbar-track {
      background: transparent;
    }

    .broadcast-results::-webkit-scrollbar-thumb {
      background: #2A2A2A;
      border-radius: 4px;
    }

    .broadcast-results::-webkit-scrollbar-thumb:hover {
      background: #3A3A3A;
    }
   /* FIX: Prevent CLS - Set dimensions for all images */
img {
  max-width: 100%;
  height: auto;
  aspect-ratio: attr(width) / attr(height);
}

/* FIX: Reserve space for dynamic content */
.profile-photo {
  width: 64px;
  height: 64px;
  flex-shrink: 0;
}

.profile-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* FIX: Request cards have consistent dimensions */
.request-card {
  background: #1F1F1F;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  display: flex;
  flex-direction: column;
  min-height: 240px;
  contain: layout style;
}

/* FIX: Shimmer loader takes up space */
.shimmer-wrapper {
  position: relative;
  width: 100%;
  padding: 16px 24px;
  opacity: 1;
  transition: opacity 0.3s ease;
  z-index: 10;
  contain: layout;
}

.shimmer-wrapper.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

/* FIX: Broadcast overlay doesn't shift layout */
.broadcast-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.95);
  z-index: 999;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  backdrop-filter: blur(5px);
  overflow-y: auto;
  padding: 20px;
  contain: strict;
}

/* FIX: Prevent font loading shift with system fonts */
body {
  font-display: swap;
}


  </style>
</head>
<body>

  <!-- Kind message shown only on real desktop/laptop (large screen + mouse) -->
  <div class="desktop-message">
    <div class="icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 4v12h12V6H6zm4 14h4v-2h-4v2z"/>
      </svg>
    </div>
    <h1>Hey there! üëã</h1>
    <p>Thank you for visiting InstaPing on your computer.<br><br>
    For the best and most secure experience, our app is currently available only on phones and tablets.<br><br>
    Please open this page on your mobile device to continue browsing live requests and connecting with others nearby.</p>
  </div>

   <header>
    <div class="logo-small">
      <!-- FIX: Add dimensions and eager loading for LCP -->
      <img 
        src="asset/logo.png" 
        alt="Coded Logo" 
        width="40" 
        height="40"
        loading="eager"
        decoding="sync"
        onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiMyQTJBMkEiLz48L3N2Zz4='"
      >
    </div>
    <div class="status-indicator status-available" id="status">
      <svg viewBox="0 0 8 8" width="12" height="12"><circle cx="4" cy="4" r="4"/></svg>
      Available
    </div>
  </header>

  <div class="feed" id="feed">
    <div class="shimmer-wrapper" id="shimmer">
      <!-- Shimmer cards will be generated dynamically -->
    </div>

    <div class="no-requests" id="no-requests">
      <div class="no-requests-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/>
        </svg>
      </div>
      <h3>No live requests right now</h3>
      <p>Be the first to post a request or check back soon ‚Äî people are always looking to connect nearby.</p>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" id="nav-live">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/></svg>
      </div>
      <div>Live</div>
    </div>
    <div class="nav-item" id="nav-favorites">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
      </div>
      <div>Favorites</div>
    </div>
    <div class="nav-item"></div>
    <div class="nav-item" id="nav-chats">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>
      </div>
      <div>Chats</div>
    </div>
    <div class="nav-item" id="nav-profile">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      </div>
      <div>Profile</div>
    </div>

    <button class="fab" id="fab-post" aria-label="Post Request">
      <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </button>
  </div>

  <!-- Animated Location Floating Button -->
  <button class="location-fab" id="location-fab" aria-label="Broadcast Scan for Nearby Users">
    <svg viewBox="0 0 24 24">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
    </svg>
    <div class="badge" id="location-badge" style="display: none;">3</div>
  </button>

  <!-- Broadcast Scanning Overlay -->
  <div class="broadcast-overlay" id="broadcast-overlay">
    <div class="broadcast-close" id="broadcast-close">
      <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
    </div>
    
    <div class="broadcast-container" id="broadcast-container">
      <div class="broadcast-signal" id="broadcast-signal">
        <div class="signal-line"></div>
        <div class="signal-line"></div>
        <div class="signal-line"></div>
        <div class="signal-line"></div>
      </div>
      
      <div class="broadcast-wave"></div>
      <div class="broadcast-wave"></div>
      <div class="broadcast-wave"></div>
      
      <div class="broadcast-center" id="broadcast-center">
        <svg viewBox="0 0 24 24">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
        </svg>
      </div>
      
      <!-- Broadcast dots will be added dynamically here -->
    </div>
    
    <div class="broadcast-text" id="broadcast-text">Broadcasting signal...</div>
    <div class="broadcast-subtext" id="broadcast-subtext">Searching for users in your area</div>
    
    <div class="broadcast-results" id="broadcast-results">
      <!-- Results will be populated here -->
    </div>
  </div>

  <div id="toast"></div>
<script>
// ==================== FAST POLLING MANAGER WITH WEBSOCKET FALLBACK ====================
class FeedPollingManager {
    constructor() {
        this.pollingInterval = null;
        this.pollingIntervalMs = 6000; // Poll every 6 seconds
        this.lastFeedUpdateTime = 0;
        this.optimisticUpdates = new Map();
        this.shouldPoll = true;
        this.pollingFailures = 0;
        this.maxPollingFailures = 3;
        this.webSocket = null;
        this.useWebSocket = false; // Start with polling
        this.connectionAttempts = 0;
        this.maxConnectionAttempts = 2;
    }

    // Try WebSocket first, fall back to polling if it fails
    connect() {
        console.log('üåê Attempting WebSocket connection...');
        this.tryWebSocket();
    }

    tryWebSocket() {
        if (this.connectionAttempts >= this.maxConnectionAttempts) {
            console.log('üì° Max WebSocket attempts reached, using polling');
            this.useWebSocket = false;
            this.startPolling();
            return;
        }

        this.connectionAttempts++;
        const token = localStorage.getItem('token');
        if (!token) {
            console.warn('No token found for WebSocket');
            this.useWebSocket = false;
            this.startPolling();
            return;
        }

        try {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host.replace(/^www\./, '');
            const wsUrl = `${protocol}//${host}/ws?token=${encodeURIComponent(token)}`;
            
            this.webSocket = new WebSocket(wsUrl);
            
            this.webSocket.onopen = () => {
                console.log('‚úÖ WebSocket connected');
                this.useWebSocket = true;
                this.connectionAttempts = 0;
                showToast('üéØ Live updates active');
                
                // Stop polling since WebSocket is working
                this.stopPolling();
                
                // Subscribe to channels
                this.send({
                    type: 'subscribe',
                    channel: 'feed_updates'
                });
            };

            this.webSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                } catch (error) {
                    console.error('WebSocket message error:', error);
                }
            };

            this.webSocket.onclose = () => {
                console.log('‚ùå WebSocket disconnected');
                this.useWebSocket = false;
                
                // Start polling as fallback
                if (this.shouldPoll) {
                    console.log('üì° Switching to HTTP polling');
                    this.startPolling();
                }
            };

            this.webSocket.onerror = () => {
                console.log('‚ö†Ô∏è WebSocket error, falling back to polling');
                this.useWebSocket = false;
                this.webSocket = null;
                
                // Try polling immediately
                this.startPolling();
            };

        } catch (error) {
            console.log('üö´ WebSocket creation failed:', error);
            this.useWebSocket = false;
            this.startPolling();
        }
    }

    startPolling() {
        if (!this.pollingInterval && this.shouldPoll) {
            console.log(`üì° Starting HTTP polling every ${this.pollingIntervalMs}ms`);
            // First poll immediately
            setTimeout(() => this.pollForNewPosts(), 100);
            
            // Then set interval
            this.pollingInterval = setInterval(async () => {
                await this.pollForNewPosts();
            }, this.pollingIntervalMs);
        }
    }

    stopPolling() {
        if (this.pollingInterval) {
            clearInterval(this.pollingInterval);
            this.pollingInterval = null;
        }
    }

    async pollForNewPosts() {
        try {
            const token = localStorage.getItem('token');
            if (!token) return;

            const response = await fetch(`${API_BASE_URL}/feed?since=${this.lastFeedUpdateTime}&limit=10`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                this.pollingFailures = 0;
                const updatedPosts = await response.json();
                
                if (updatedPosts.length > 0) {
                    console.log('üîÑ Polling found', updatedPosts.length, 'new posts');
                    this.lastFeedUpdateTime = Math.floor(Date.now() / 1000);
                    
                    updatedPosts.forEach(post => {
                        this.processUpdatedPost(post);
                    });
                }
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
            
        } catch (error) {
            console.log('üì° Polling error:', error.message);
            this.pollingFailures++;
            
            if (this.pollingFailures >= this.maxPollingFailures) {
                console.log('‚ö†Ô∏è Too many polling failures, pausing');
                this.stopPolling();
                
                // Try again in 30 seconds
                setTimeout(() => {
                    this.pollingFailures = 0;
                    this.startPolling();
                }, 30000);
            }
        }
    }

    handleWebSocketMessage(data) {
        const { type, payload } = data;
        
        switch (type) {
            case 'new_request':
                this.handleNewRequest(payload);
                break;
            case 'request_update':
                this.handleRequestUpdate(payload);
                break;
            case 'request_removed':
                this.handleRequestRemoved(payload);
                break;
            case 'user_status_update':
                this.handleUserStatusUpdate(payload);
                break;
            case 'pong':
                // Heartbeat response
                break;
            default:
                console.log('WebSocket message:', type);
        }
    }

    handleNewRequest(request) {
        console.log('üÜï WebSocket: New request', request.id);
        const currentUserId = parseJwt(localStorage.getItem('token'));
        if (request.userId === currentUserId) return;
        
        showToast(`üì¢ ${request.user?.name || 'Someone'} posted nearby`);
        playNotificationSound();
        addRequestToFeed(request);
    }

    handleRequestUpdate(update) {
        console.log('‚úèÔ∏è WebSocket: Request updated', update.id);
        updateRequestInFeed(update);
    }

    handleRequestRemoved(requestId) {
        console.log('üóëÔ∏è WebSocket: Request removed', requestId);
        removeRequestFromFeed(requestId);
    }

    handleUserStatusUpdate(update) {
        console.log('üìä WebSocket: User status', update.userId, update.status);
        updateUserStatusInFeed(update.userId, update.status);
    }

    send(data) {
        if (this.useWebSocket && this.webSocket?.readyState === WebSocket.OPEN) {
            this.webSocket.send(JSON.stringify(data));
            return true;
        }
        return false;
    }

    disconnect() {
        this.shouldPoll = false;
        this.stopPolling();
        
        if (this.webSocket) {
            this.webSocket.close();
            this.webSocket = null;
        }
    }
}

// ==================== GLOBAL VARIABLES ====================
const fallbackImage = 'https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png';
const API_BASE_URL = 'https://www.instaping.org/api';
const feedManager = new FeedPollingManager();

// ==================== HELPER FUNCTIONS ====================

// Create shimmer cards dynamically
function createShimmerCards() {
    const shimmerEl = document.getElementById('shimmer');
    if (!shimmerEl) return;
    
    shimmerEl.innerHTML = '';
    
    for (let i = 0; i < 4; i++) {
        const card = document.createElement('div');
        card.className = 'shimmer-card';
        card.innerHTML = `
            <div class="shimmer-header">
                <div class="shimmer-photo"></div>
                <div class="shimmer-lines">
                    <div class="shimmer-line"></div>
                    <div class="shimmer-line short"></div>
                </div>
            </div>
            <div class="shimmer-category"></div>
            <div class="shimmer-text long"></div>
            <div class="shimmer-text long"></div>
            <div class="shimmer-text medium"></div>
            <div class="shimmer-footer">
                <div class="shimmer-time">
                    <div class="shimmer-time-icon"></div>
                    <div class="shimmer-time-text"></div>
                </div>
                <div class="shimmer-actions">
                    <div class="shimmer-btn"></div>
                    <div class="shimmer-btn"></div>
                    <div class="shimmer-btn"></div>
                </div>
            </div>
        `;
        shimmerEl.appendChild(card);
    }
}

function showToast(message, duration = 2000) {
    const toast = document.getElementById('toast');
    if (!toast) return;
    
    toast.textContent = message;
    toast.classList.add('show');
    clearTimeout(toast.hideTimeout);
    toast.hideTimeout = setTimeout(() => toast.classList.remove('show'), duration);
}

function playNotificationSound() {
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
        audio.volume = 0.2;
        audio.play().catch(() => {});
    } catch (e) {}
}

function formatDistance(distance) {
    if (!distance || distance === 'Unknown') return 'Nearby';
    
    if (typeof distance === 'number') {
        if (distance < 1000) {
            return `${Math.round(distance)}m away`;
        } else {
            return `${(distance / 1000).toFixed(1)}km away`;
        }
    }
    
    if (typeof distance === 'string') {
        const num = parseFloat(distance);
        if (!isNaN(num)) {
            if (num < 1000) return `${Math.round(num)}m away`;
            return `${(num / 1000).toFixed(1)}km away`;
        }
    }
    return 'Nearby';
}

async function fetchWithAuth(url, options = {}) {
    const token = localStorage.getItem('token');
    if (!token) {
        showToast('Please log in first');
        setTimeout(() => window.location.href = 'login.html', 1000);
        throw new Error('No token');
    }

    const headers = {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        ...options.headers
    };

    try {
        const response = await fetch(url, { ...options, headers });
        
        if (response.status === 401) {
            showToast('Session expired');
            localStorage.removeItem('token');
            setTimeout(() => window.location.href = 'login.html', 1500);
            throw new Error('Unauthorized');
        }
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        if (response.status === 204) return response;
        return response;
    } catch (error) {
        if (error.message !== 'Unauthorized') {
            console.error('Fetch error:', error);
        }
        throw error;
    }
}

function parseJwt(token) {
    if (!token) return null;
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => 
            '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        const payload = JSON.parse(jsonPayload);
        return payload.userId || payload.sub || payload.id || null;
    } catch (e) {
        return null;
    }
}

// ==================== FAST FEED FUNCTIONS ====================

function addRequestToFeed(request) {
    const feedEl = document.getElementById('feed');
    const noRequestsEl = document.getElementById('no-requests');
    const shimmerEl = document.getElementById('shimmer');
    
    if (!feedEl) return;
    
    // Hide loading states
    if (shimmerEl && !shimmerEl.classList.contains('hidden')) {
        shimmerEl.classList.add('hidden');
    }
    if (noRequestsEl && noRequestsEl.style.display === 'block') {
        noRequestsEl.style.display = 'none';
    }
    
    // Check if already exists
    if (document.querySelector(`[data-post-id="${request.id}"]`)) return;
    
    const currentUserId = parseJwt(localStorage.getItem('token'));
    if (request.userId === currentUserId) return;
    
    const requestUser = request.user || {};
    
    // Create card with minimal DOM operations
    const card = document.createElement('div');
    card.className = 'request-card';
    card.dataset.postId = request.id;
    card.dataset.userId = request.userId;
    card.style.opacity = '0';
    card.style.transform = 'translateY(-20px)';
    
    card.innerHTML = `
        <div class="card-header">
            <div class="profile-photo">
                <img src="${requestUser.avatar || fallbackImage}" alt="${requestUser.name || 'User'}" onerror="this.src='${fallbackImage}'">
            </div>
            <div class="user-info">
                <div class="name-age">${requestUser.name || 'User'}</div>
                <div class="distance">${formatDistance(request.distance)}</div>
            </div>
        </div>
        ${request.category ? `<div class="category">${request.category}</div>` : ''}
        <div class="request-text">${request.content || 'No content'}</div>
        <div class="card-footer">
            <div class="time-rating">Just now</div>
            <div class="actions">
                <button class="action-btn ignore" title="Ignore">‚úï</button>
                <button class="action-btn favorite" title="Favorite">‚ù§</button>
                <button class="action-btn accept" title="Accept">‚úì</button>
            </div>
        </div>
    `;
    
    // Add to top of feed
    if (feedEl.firstChild) {
        feedEl.insertBefore(card, feedEl.firstChild);
    } else {
        feedEl.appendChild(card);
    }
    
    // Animate entry
    requestAnimationFrame(() => {
        card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
    });
    
    checkEmpty();
}

function updateRequestInFeed(update) {
    const card = document.querySelector(`[data-post-id="${update.id}"]`);
    if (!card) return;
    
    if (update.content) {
        const textEl = card.querySelector('.request-text');
        if (textEl) {
            textEl.textContent = update.content;
            textEl.style.backgroundColor = '#2A2A2A';
            setTimeout(() => textEl.style.backgroundColor = '', 300);
        }
    }
}

function removeRequestFromFeed(requestId) {
    const card = document.querySelector(`[data-post-id="${requestId}"]`);
    if (card) {
        card.style.transition = 'opacity 0.3s, transform 0.3s';
        card.style.opacity = '0';
        card.style.transform = 'translateX(-100%)';
        
        setTimeout(() => {
            card.remove();
            checkEmpty();
        }, 300);
    }
}

function updateUserStatusInFeed(userId, status) {
    const cards = document.querySelectorAll(`[data-user-id="${userId}"]`);
    cards.forEach(card => {
        const statusEl = card.querySelector('.user-status');
        if (statusEl) {
            const statusColors = {
                'available': '#00FF00',
                'busy': '#FFFF00',
                'offline': '#FF0000'
            };
            statusEl.style.color = statusColors[status] || '#00FF00';
        }
    });
}

function checkEmpty() {
    const feedEl = document.getElementById('feed');
    const noRequestsEl = document.getElementById('no-requests');
    const shimmerEl = document.getElementById('shimmer');
    
    if (!feedEl) return;
    
    const cards = feedEl.querySelectorAll('.request-card');
    
    if (cards.length === 0) {
        if (shimmerEl && !shimmerEl.classList.contains('hidden')) {
            shimmerEl.classList.add('hidden');
        }
        if (noRequestsEl) {
            noRequestsEl.style.display = 'block';
        }
    } else {
        if (noRequestsEl) {
            noRequestsEl.style.display = 'none';
        }
        if (shimmerEl && !shimmerEl.classList.contains('hidden')) {
            shimmerEl.classList.add('hidden');
        }
    }
}

// ==================== INITIALIZATION ====================

(function() {
    // Create shimmer immediately (critical for perceived performance)
    createShimmerCards();
    
    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
        showToast('Please log in');
        setTimeout(() => window.location.href = 'login.html', 1000);
        return;
    }
    
    const currentUserId = parseJwt(token);
    if (!currentUserId) {
        showToast('Invalid session');
        localStorage.removeItem('token');
        setTimeout(() => window.location.href = 'login.html', 1500);
        return;
    }

    // Load initial feed FAST
    setTimeout(() => loadInitialFeed(), 50);
    
    // Connect to real-time updates
    setTimeout(() => feedManager.connect(), 500);

    // Setup event handlers
    setupEventHandlers();
    setupNavigation();
    
    // Load user status
    loadUserStatus();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        feedManager.disconnect();
    });

    console.log('üöÄ Feed page initialized');
})();

// ==================== FAST INITIAL FEED LOAD ====================

async function loadInitialFeed() {
    const feedEl = document.getElementById('feed');
    const noRequestsEl = document.getElementById('no-requests');
    const shimmerEl = document.getElementById('shimmer');
    
    if (!feedEl || !noRequestsEl || !shimmerEl) return;
    
    // Show shimmer while loading
    shimmerEl.classList.remove('hidden');
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/feed?limit=15`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const posts = await response.json();
            const postsArray = Array.isArray(posts) ? posts : [];
            
            feedEl.innerHTML = '';
            
            if (postsArray.length === 0) {
                noRequestsEl.style.display = 'block';
                shimmerEl.classList.add('hidden');
                return;
            }
            
            // Load first 5 posts immediately for fast display
            const initialPosts = postsArray.slice(0, 5);
            const remainingPosts = postsArray.slice(5);
            
            // Display initial posts
            initialPosts.forEach(post => {
                if (post.userId !== currentUserId) {
                    createPostCard(post);
                }
            });
            
            // Hide shimmer after initial load
            shimmerEl.classList.add('hidden');
            
            // Load remaining posts in background
            if (remainingPosts.length > 0) {
                setTimeout(() => {
                    remainingPosts.forEach(post => {
                        if (post.userId !== currentUserId) {
                            createPostCard(post);
                        }
                    });
                }, 100);
            }
            
            checkEmpty();
        }
    } catch (err) {
        console.error('Feed load error:', err);
        feedEl.innerHTML = '<div class="loading-state">Error loading feed</div>';
        shimmerEl.classList.add('hidden');
    }
}

function createPostCard(post) {
    const feedEl = document.getElementById('feed');
    if (!feedEl) return;
    
    const postUser = post.user || {};
    const currentUserId = parseJwt(localStorage.getItem('token'));
    if (postUser.id === currentUserId) return;
    
    const card = document.createElement('div');
    card.className = 'request-card';
    card.dataset.postId = post.id;
    card.dataset.userId = postUser.id;
    
    card.innerHTML = `
        <div class="card-header">
            <div class="profile-photo">
                <img src="${postUser.avatar || fallbackImage}" alt="${postUser.name || 'User'}" onerror="this.src='${fallbackImage}'">
            </div>
            <div class="user-info">
                <div class="name-age">${postUser.name || 'User'}</div>
                <div class="distance">${formatDistance(post.distance)}</div>
            </div>
        </div>
        ${post.category ? `<div class="category">${post.category}</div>` : ''}
        <div class="request-text">${post.content || 'No content'}</div>
        <div class="card-footer">
            <div class="time-rating">Just now</div>
            <div class="actions">
                <button class="action-btn ignore" title="Ignore">‚úï</button>
                <button class="action-btn favorite" title="Favorite">‚ù§</button>
                <button class="action-btn accept" title="Accept">‚úì</button>
            </div>
        </div>
    `;
    
    feedEl.appendChild(card);
}

// ==================== USER STATUS ====================

async function loadUserStatus() {
    const statusEl = document.getElementById('status');
    if (!statusEl) return;
    
    const statuses = [
        { text: 'Available', class: 'status-available', value: 'available' },
        { text: 'Busy', class: 'status-busy', value: 'busy' },
        { text: 'Offline', class: 'status-offline', value: 'offline' }
    ];
    let currentStatusIndex = 0;
    
    try {
        const response = await fetchWithAuth(`${API_BASE_URL}/me`);
        if (response.ok) {
            const data = await response.json();
            const statusValue = data.status || 'available';
            const index = statuses.findIndex(s => s.value === statusValue);
            if (index !== -1) {
                currentStatusIndex = index;
                updateStatusUI();
            }
        }
    } catch (err) {
        console.log('Status load error:', err);
    }
    
    function updateStatusUI() {
        const s = statuses[currentStatusIndex];
        statusEl.className = `status-indicator ${s.class}`;
        statusEl.innerHTML = `<span>${s.text}</span>`;
    }
    
    statusEl.addEventListener('click', async () => {
        currentStatusIndex = (currentStatusIndex + 1) % statuses.length;
        updateStatusUI();
        const newStatus = statuses[currentStatusIndex].value;
        
        try {
            await fetchWithAuth(`${API_BASE_URL}/me/status`, {
                method: 'PUT',
                body: JSON.stringify({ status: newStatus })
            });
            showToast(`Status: ${newStatus}`);
        } catch (err) {
            console.error('Status update error:', err);
        }
    });
}

// ==================== EVENT HANDLERS ====================

function setupEventHandlers() {
    document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.action-btn');
        if (!btn) return;

        const card = btn.closest('.request-card');
        if (!card) return;
        
        const userId = card.dataset.userId;
        const postId = card.dataset.postId;
        const currentUserId = parseJwt(localStorage.getItem('token'));

        if (userId === currentUserId) {
            showToast('Cannot interact with your own post');
            return;
        }

        if (btn.classList.contains('accept')) {
            try {
                const res = await fetchWithAuth(`${API_BASE_URL}/chats`, {
                    method: 'POST',
                    body: JSON.stringify({ participants: [userId] })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    showToast('ü§ù Chat created!');
                    
                    // Remove card
                    card.style.transition = 'opacity 0.3s, transform 0.3s';
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(100%)';
                    
                    setTimeout(() => {
                        card.remove();
                        checkEmpty();
                        window.location.href = `chat.html?id=${data.id}`;
                    }, 300);
                }
            } catch (err) {
                showToast('Failed to create chat');
            }
            
        } else if (btn.classList.contains('favorite')) {
            const isFavorited = btn.classList.contains('favorited');
            
            try {
                if (isFavorited) {
                    await fetchWithAuth(`${API_BASE_URL}/favorite`, {
                        method: 'DELETE',
                        body: JSON.stringify({ targetUserId: userId })
                    });
                    btn.classList.remove('favorited');
                    btn.title = 'Add to favorites';
                    showToast('üíî Removed from favorites');
                } else {
                    await fetchWithAuth(`${API_BASE_URL}/favorite`, {
                        method: 'POST',
                        body: JSON.stringify({ targetUserId: userId })
                    });
                    btn.classList.add('favorited');
                    btn.title = 'Remove from favorites';
                    showToast('‚ù§Ô∏è Added to favorites');
                }
                
                // Remove card
                card.style.transition = 'opacity 0.3s, transform 0.3s';
                card.style.opacity = '0';
                card.style.transform = 'translateY(-20px)';
                
                setTimeout(() => {
                    card.remove();
                    checkEmpty();
                }, 300);
                
            } catch (err) {
                showToast('Failed to update favorite');
            }
            
        } else if (btn.classList.contains('ignore')) {
            // Remove card immediately
            card.style.transition = 'opacity 0.3s, transform 0.3s';
            card.style.opacity = '0';
            card.style.transform = 'translateX(-100%)';
            
            setTimeout(() => {
                card.remove();
                checkEmpty();
            }, 300);
            
            showToast('üëé Request ignored');
        }
    });

    document.addEventListener('click', (e) => {
        const cardHeader = e.target.closest('.card-header');
        if (cardHeader) {
            const card = cardHeader.closest('.request-card');
            if (!card) return;
            
            const userId = card.dataset.userId;
            const currentUserId = parseJwt(localStorage.getItem('token'));
            
            if (userId && userId !== currentUserId) {
                window.location.href = `view-profile.html?id=${userId}`;
            }
        }
    });
}

// ==================== NAVIGATION ====================

function setupNavigation() {
    const navLive = document.getElementById('nav-live');
    const navFavorites = document.getElementById('nav-favorites');
    const navChats = document.getElementById('nav-chats');
    const navProfile = document.getElementById('nav-profile');
    const fabPost = document.getElementById('fab-post');
    
    if (navLive) {
        navLive.addEventListener('click', () => {
            loadInitialFeed();
            showToast('üîÑ Feed refreshed');
        });
    }
    
    if (navFavorites) {
        navFavorites.addEventListener('click', () => window.location.href = 'favorites.html');
    }
    
    if (navChats) {
        navChats.addEventListener('click', () => window.location.href = 'chats.html');
    }
    
    if (navProfile) {
        navProfile.addEventListener('click', () => window.location.href = 'my-profile.html');
    }

    if (fabPost) {
        fabPost.addEventListener('click', () => {
            window.location.href = 'post.html';
        });
    }
}
</script>
</body>

</html>
