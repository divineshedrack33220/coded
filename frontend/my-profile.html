<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile | Coded</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000000;
      color: #FFFFFF;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #000000;
      z-index: 1000;
      border-bottom: 1px solid #1A1A1A;
    }

    .back-btn {
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .back-btn svg {
      width: 24px;
      height: 24px;
      fill: #FFFFFF;
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      flex: 1;
    }

    .header-right {
      opacity: 0.8;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .profile-container {
      padding: 80px 20px 20px;
      max-width: 480px;
      margin: 0 auto;
    }

    .profile-hero {
      text-align: center;
      margin-bottom: 24px;
    }

    .avatar-wrapper {
      position: relative;
      display: inline-block;
      margin-bottom: 12px;
    }

    .avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #FFFFFF;
      box-shadow: 0 0 0 4px rgba(255,255,255,0.1);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .avatar:hover {
      transform: scale(1.05);
    }

    .username {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .handle {
      font-size: 16px;
      color: #8E8E8E;
      margin-bottom: 16px;
    }

    .stats {
      display: flex;
      justify-content: space-around;
      margin: 24px 0;
      padding: 16px 0;
      border-top: 1px solid #1A1A1A;
      border-bottom: 1px solid #1A1A1A;
    }

    .stat {
      text-align: center;
      cursor: pointer;
    }

    .stat-number {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 14px;
      color: #8E8E8E;
    }

    .bio-section {
      margin-bottom: 32px;
      position: relative;
    }

    .bio {
      font-size: 16px;
      line-height: 1.5;
      color: #D0D0D0;
      margin-bottom: 12px;
    }

    .edit-bio {
      position: absolute;
      top: 0;
      right: 0;
      font-size: 20px;
      color: #FFFFFF;
      opacity: 0.7;
      cursor: pointer;
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
    }

    .btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .btn-primary {
      background: #FFFFFF;
      color: #000000;
    }

    .btn-primary:hover {
      background: #E0E0E0;
    }

    .btn-secondary {
      background: #1A1A1A;
      color: #FFFFFF;
      border: 1px solid #333333;
    }

    .btn-secondary:hover {
      background: #252525;
    }

    .tabs {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      border-bottom: 1px solid #1A1A1A;
    }

    .tab {
      padding: 12px 0;
      font-size: 16px;
      font-weight: 600;
      color: #8E8E8E;
      cursor: pointer;
      position: relative;
      flex: 1;
      text-align: center;
    }

    .tab.active {
      color: #FFFFFF;
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 2px;
      background: #FFFFFF;
      border-radius: 2px;
    }

    .content-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 32px;
    }

    .post-card {
      aspect-ratio: 1 / 1;
      background: #111111;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .post-card:hover {
      transform: scale(1.03);
    }

    .post-thumbnail {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .post-overlay {
      position: absolute;
      bottom: 12px;
      left: 12px;
      font-size: 14px;
      background: rgba(0,0,0,0.6);
      padding: 4px 8px;
      border-radius: 12px;
    }

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-backdrop.active {
      display: block;
      opacity: 1;
    }

    .bottom-modal {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #111111;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      padding: 20px 0;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-height: 70vh;
      overflow-y: auto;
    }

    .bottom-modal.active {
      transform: translateY(0);
    }

    .modal-handle {
      width: 40px;
      height: 4px;
      background: #444;
      border-radius: 2px;
      margin: 0 auto 16px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 20px;
    }

    .modal-option {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      cursor: pointer;
    }

    .modal-option:hover {
      background: #1A1A1A;
    }

    .modal-icon {
      width: 24px;
      height: 24px;
      margin-right: 16px;
      fill: #FFFFFF;
    }

    .modal-text {
      font-size: 16px;
    }

    .logout {
      color: #FF3B30 !important;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #8E8E8E;
    }

    .empty-illustration {
      font-size: 80px;
      margin-bottom: 16px;
    }

    #toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(31, 31, 31, 0.95);
      color: #FFFFFF;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 200;
      max-width: 90%;
      text-align: center;
      backdrop-filter: blur(8px);
    }

    #toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-8px);
    }
  </style>
</head>
<body>

  <header>
    <button class="back-btn" id="back-btn" aria-label="Back">
      <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </button>
    <div class="header-title">My Profile</div>
    <div class="header-right" id="settings-icon">
      <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.37-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.37 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.37 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.37-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z" fill="#FFFFFF"/></svg>
    </div>
  </header>

  <div class="profile-container">

    <div class="profile-hero">
      <div class="avatar-wrapper">
        <img class="avatar" id="avatar" src="" alt="Profile">
      </div>
      <div class="username" id="username">Loading...</div>
      <div class="handle" id="handle">@loading</div>
    </div>

    <div class="stats">
      <div class="stat" id="connections-stat">
        <div class="stat-number">0</div>
        <div class="stat-label">Connections</div>
      </div>
      <div class="stat" id="favorites-stat">
        <div class="stat-number">0</div>
        <div class="stat-label">Favorites</div>
      </div>
      <div class="stat" id="chats-stat">
        <div class="stat-number">0</div>
        <div class="stat-label">Chats</div>
      </div>
    </div>

    <div class="bio-section">
      <div class="edit-bio" id="edit-bio">‚úé</div>
      <p class="bio" id="bio">Loading bio...</p>
    </div>

    <div class="actions">
      <div class="btn btn-primary" id="edit-profile-btn">Edit Profile</div>
      <div class="btn btn-secondary" id="share-profile-btn">Share Profile</div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active">Posts</div>
      <div class="tab">Media</div>
      <div class="tab">Saved</div>
    </div>

    <div class="content-grid" id="content-grid">
      <!-- Content will be loaded here -->
    </div>

    <div class="empty-state" id="empty-state" style="display: none;">
      <div class="empty-illustration">üì∑</div>
      <h3 id="empty-title">No posts yet</h3>
      <p id="empty-message">Share your first post to connect with others</p>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-backdrop" id="modal-backdrop"></div>
  <div class="bottom-modal" id="settings-modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Settings</div>

    <!-- Referral Option -->
    <div class="modal-option" id="referral-option">
      <svg class="modal-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v4h4v2h-4v4h-2v-4H8v-2h4V7z" fill="#FFFFFF"/></svg>
      <div class="modal-text">Refer a Friend</div>
    </div>

    <!-- Logout -->
    <div class="modal-option logout" id="logout-btn">
      <svg class="modal-icon" viewBox="0 0 24 24"><path d="M17 8l-1.41 1.41L18.17 12H9v2h9.17l-2.58 2.58L17 18l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
      <div class="modal-text">Logout</div>
    </div>
  </div>

  <!-- Referral Modal -->
  <div class="modal-backdrop" id="referral-backdrop"></div>
  <div class="bottom-modal" id="referral-modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Refer a Friend</div>

    <div style="padding: 0 20px; text-align: center; margin-bottom: 24px;">
      <p style="font-size: 16px; margin-bottom: 8px;">Invite your friends to join Coded!</p>
      <p style="font-size: 14px; color: #8E8E8E;">You both get bonus connections when they sign up.</p>
    </div>

    <div style="padding: 0 20px; margin-bottom: 24px;">
      <div id="referral-link" style="background: #1A1A1A; padding: 12px; border-radius: 12px; word-break: break-all; font-size: 14px; margin-bottom: 12px;"></div>
      <div style="display: flex; gap: 12px;">
        <button id="copy-link-btn" class="btn btn-primary" style="flex: 1;">Copy Link</button>
        <button id="share-referral-btn" class="btn btn-secondary" style="flex: 1;">Share</button>
      </div>
    </div>

    <div style="padding: 0 20px;">
      <p style="font-size: 14px; color: #8E8E8E; text-align: center;">Your referral code: <span id="referral-code" style="color: #FFFFFF; font-weight: 600;">Loading...</span></p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script>
    const fallbackImage = 'https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png';

    function showToast(message, duration = 2000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      clearTimeout(toast.hideTimeout);
      toast.hideTimeout = setTimeout(() => toast.classList.remove('show'), duration);
    }

    (function() {
      const token = localStorage.getItem('token');
      if (!token) {
        showToast('Please log in first.');
        setTimeout(() => window.location.href = 'login.html', 1500);
        return;
      }

      const avatarEl = document.getElementById('avatar');
      const usernameEl = document.getElementById('username');
      const handleEl = document.getElementById('handle');
      const bioEl = document.getElementById('bio');
      const connectionsEl = document.getElementById('connections-stat').querySelector('.stat-number');
      const favoritesEl = document.getElementById('favorites-stat').querySelector('.stat-number');
      const chatsEl = document.getElementById('chats-stat').querySelector('.stat-number');
      const contentGrid = document.getElementById('content-grid');
      const emptyState = document.getElementById('empty-state');
      const emptyTitle = document.getElementById('empty-title');
      const emptyMessage = document.getElementById('empty-message');
      const tabs = document.querySelectorAll('.tab');
      let currentTab = 0;
      let profileData = null;

      async function loadProfile() {
        try {
          const res = await fetch('https://codedsignal.org/me', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('Failed to load profile');
          const data = await res.json();

          profileData = data;

          let avatarSrc = data.avatar || fallbackImage;
          if (!data.avatar && data.photos && data.photos.length > 0) {
            avatarSrc = data.photos[0];
          }
          avatarEl.src = avatarSrc;
          avatarEl.onerror = () => { avatarEl.src = fallbackImage; };

          usernameEl.textContent = data.name || 'User';
          handleEl.textContent = `@${data.username || 'user'}`;
          bioEl.textContent = data.bio || 'No bio yet';
          connectionsEl.textContent = data.connections || '0';
          favoritesEl.textContent = data.favoritesCount || '0';
          chatsEl.textContent = data.chatsCount || '0';

          // Load referral link
          loadReferralLink();

          loadContent();
        } catch (err) {
          console.error('Profile load error:', err);
          showToast('Failed to load profile');
          avatarEl.src = fallbackImage;
          usernameEl.textContent = 'Error';
          bioEl.textContent = 'Failed to load profile';
        }
      }

      async function loadReferralLink() {
        try {
          const res = await fetch('https://codedsignal.org/me/referral', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('Failed to load referral');
          const { referralCode, referralUrl } = await res.json();

          document.getElementById('referral-code').textContent = referralCode;
          document.getElementById('referral-link').textContent = referralUrl;

          // Store for sharing
          window.referralData = {
            url: referralUrl,
            text: `Hey! Join me on Coded with my referral link: ${referralUrl}`,
            title: 'Join Coded with my referral!'
          };
        } catch (err) {
          console.error('Referral load error:', err);
          showToast('Failed to load referral link');
        }
      }

      function switchTab(index) {
        tabs.forEach(t => t.classList.remove('active'));
        tabs[index].classList.add('active');
        currentTab = index;
        loadContent();
      }

      function loadContent() {
        contentGrid.innerHTML = '';
        emptyState.style.display = 'none';

        if (currentTab === 0) loadPosts();
        else if (currentTab === 1) loadMedia();
        else loadSaved();
      }

      async function loadPosts() {
        try {
          const res = await fetch(`https://codedsignal.org/user/${profileData.id}/posts`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('Failed to load posts');
          const posts = await res.json();

          if (posts.length === 0) {
            emptyTitle.textContent = 'No posts yet';
            emptyMessage.textContent = 'Share your first post to connect with others';
            emptyState.style.display = 'block';
          } else {
            posts.forEach(post => {
              const card = document.createElement('div');
              card.className = 'post-card';
              card.innerHTML = `
                <img class="post-thumbnail" src="${post.media?.[0] || 'https://picsum.photos/300/300?random=' + post.id}" alt="Post">
                <div class="post-overlay">‚ù§Ô∏è ${post.likes || 0}</div>
              `;
              contentGrid.appendChild(card);
            });
          }
        } catch (err) {
          console.error('Posts load error:', err);
          showToast('Failed to load posts');
          emptyState.style.display = 'block';
        }
      }

      function loadMedia() {
        const photos = profileData.photos || [];
        if (photos.length === 0) {
          emptyTitle.textContent = 'No media yet';
          emptyMessage.textContent = 'Upload your first photo in edit profile';
          emptyState.style.display = 'block';
          return;
        }
        photos.forEach(url => {
          const card = document.createElement('div');
          card.className = 'post-card';
          card.innerHTML = `<img class="post-thumbnail" src="${url}" alt="Media">`;
          contentGrid.appendChild(card);
        });
      }

      function loadSaved() {
        emptyTitle.textContent = 'No saved items';
        emptyMessage.textContent = 'Save posts or media to see them here';
        emptyState.style.display = 'block';
      }

      tabs.forEach((tab, index) => {
        tab.addEventListener('click', () => switchTab(index));
      });

      document.getElementById('edit-profile-btn').addEventListener('click', () => {
        window.location.href = 'profile-settings.html';
      });

      document.getElementById('share-profile-btn').addEventListener('click', async () => {
        if (!profileData || !profileData.username) {
          showToast('Profile not loaded yet');
          return;
        }
        const shareUrl = `${window.location.origin}/@${profileData.username}`;
        const shareData = {
          title: `${profileData.name || 'User'}'s Profile on Coded`,
          text: 'Check out my profile on Coded!',
          url: shareUrl
        };

        try {
          if (navigator.share && navigator.canShare(shareData)) {
            await navigator.share(shareData);
          } else {
            await navigator.clipboard.writeText(shareUrl);
            showToast('Profile URL copied!');
          }
        } catch (err) {
          showToast('Failed to share profile');
        }
      });

      // Settings Modal
      const settingsIcon = document.getElementById('settings-icon');
      const modalBackdrop = document.getElementById('modal-backdrop');
      const settingsModal = document.getElementById('settings-modal');

      settingsIcon.addEventListener('click', () => {
        modalBackdrop.classList.add('active');
        settingsModal.classList.add('active');
      });

      modalBackdrop.addEventListener('click', () => {
        modalBackdrop.classList.remove('active');
        settingsModal.classList.remove('active');
      });

      // Referral Modal
      const referralOption = document.getElementById('referral-option');
      const referralBackdrop = document.getElementById('referral-backdrop');
      const referralModal = document.getElementById('referral-modal');

      referralOption.addEventListener('click', () => {
        settingsModal.classList.remove('active');
        modalBackdrop.classList.remove('active');
        referralBackdrop.classList.add('active');
        referralModal.classList.add('active');
      });

      referralBackdrop.addEventListener('click', () => {
        referralBackdrop.classList.remove('active');
        referralModal.classList.remove('active');
      });

      // Copy Link
      document.getElementById('copy-link-btn').addEventListener('click', () => {
        if (window.referralData?.url) {
          navigator.clipboard.writeText(window.referralData.url);
          showToast('Referral link copied!');
        } else {
          showToast('Referral link not available');
        }
      });

      // Share Referral
      document.getElementById('share-referral-btn').addEventListener('click', async () => {
        if (!window.referralData) {
          showToast('Referral data not loaded');
          return;
        }
        try {
          if (navigator.share && navigator.canShare(window.referralData)) {
            await navigator.share(window.referralData);
          } else {
            await navigator.clipboard.writeText(window.referralData.url);
            showToast('Referral link copied!');
          }
        } catch (err) {
          showToast('Failed to share');
        }
      });

      // Logout
      document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('token');
        showToast('Logged out');
        setTimeout(() => window.location.href = 'login.html', 800);
      });

      document.getElementById('back-btn').addEventListener('click', () => {
        window.history.back();
      });

      loadProfile();
    })();
  </script>
</body>
</html>