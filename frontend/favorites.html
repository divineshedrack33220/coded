<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coded | Favorites</title>
 <link rel="icon" type="image/png" href="./logo.png">
<link rel="icon" type="image/jpeg" href="./logo.jpeg">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000000; color: #FFFFFF; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid #2A2A2A; background: #000000; position: sticky; top: 0; z-index: 100; }
    .logo-small { width: 40px; height: 40px; }
    .logo-small img { width: 100%; height: 100%; object-fit: contain; }
    .status-indicator { padding: 8px 16px; background: #1F1F1F; border: 1px solid #2A2A2A; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .status-indicator svg { width: 12px; height: 12px; }
    .status-available svg { fill: #00FF00; }
    .status-busy svg { fill: #FFFF00; }
    .status-offline svg { fill: #FF0000; }
    .favorites-list { flex: 1; overflow-y: auto; padding: 16px 24px 80px; display: flex; flex-direction: column; }
    .favorite-card { background: #1F1F1F; border-radius: 20px; padding: 20px; margin-bottom: 20px; display: flex; align-items: center; position: relative; overflow: hidden; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .favorite-card:active { transform: scale(0.98); }
    .profile-photo { width: 72px; height: 72px; border-radius: 50%; overflow: hidden; margin-right: 20px; background: #2A2A2A; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
    .profile-photo img { width: 100%; height: 100%; object-fit: cover; }
    .user-details { flex: 1; min-width: 0; }
    .name-age { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
    .bio-snippet { font-size: 15px; color: #A0A0A0; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .meta-info { display: flex; align-items: center; gap: 12px; font-size: 14px; color: #8E8E8E; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #808080; box-shadow: 0 0 8px rgba(255,255,255,0.1); }
    .status-dot.online { background: #00FF00; box-shadow: 0 0 12px #00FF0080; }
    .favorite-icon { padding: 12px; margin-left: 12px; cursor: pointer; }
    .favorite-icon svg { width: 28px; height: 28px; fill: #FF0000; transition: transform 0.3s ease; }
    .favorite-icon:active svg { animation: pulse 0.5s ease; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1); } }
    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 24px; text-align: center; }
    .empty-icon { width: 120px; height: 120px; margin-bottom: 32px; opacity: 0.3; }
    .empty-title { font-size: 20px; margin-bottom: 12px; }
    .empty-subtitle { font-size: 16px; color: #8E8E8E; line-height: 1.5; }
    .bottom-nav { display: flex; height: 64px; background: #1F1F1F; border-top: 1px solid #2A2A2A; position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; color: #8E8E8E; }
    .nav-item.active { color: #FFFFFF; }
    .nav-icon svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
    .fab { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 64px; height: 64px; background: #FFFFFF; color: #000000; border-radius: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.5); cursor: pointer; z-index: 101; }
    .fab svg { width: 32px; height: 32px; fill: currentColor; }
    #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(31, 31, 31, 0.95); color: #FFFFFF; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, transform 0.3s ease; z-index: 200; max-width: 90%; text-align: center; backdrop-filter: blur(8px); }
    #toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-8px); }
    .loading-state { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #8E8E8E; }
  </style>
</head>
<body>
  <header>
    <div class="logo-small">
      <img src="asset/logo.png" alt="Coded Logo">
    </div>
    <div class="status-indicator status-available" id="status">
      <svg viewBox="0 0 8 8"><circle cx="4" cy="4" r="4"/></svg>
      Available
    </div>
  </header>

  <div class="favorites-list" id="favorites-list">
    <div class="loading-state">Loading favorites...</div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item" id="nav-live">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/></svg>
      </div>
      <div>Live</div>
    </div>
    <div class="nav-item active" id="nav-favorites">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
      </div>
      <div>Favorites</div>
    </div>
    <div class="nav-item"></div>
    <div class="nav-item" id="nav-chats">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>
      </div>
      <div>Chats</div>
    </div>
    <div class="nav-item" id="nav-profile">
      <div class="nav-icon">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      </div>
      <div>Profile</div>
    </div>

    <button class="fab" id="fab-post" aria-label="Post Request">
      <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </button>
  </div>

  <div id="toast"></div>

  <script>
    const fallbackImage = 'https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png';

    function showToast(message, duration = 2000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      clearTimeout(toast.hideTimeout);
      toast.hideTimeout = setTimeout(() => toast.classList.remove('show'), duration);
    }

    (function() {
      const token = localStorage.getItem('token');
      if (!token || token.length < 100) {
        showToast('Invalid or missing session. Please log in.');
        localStorage.removeItem('token');
        setTimeout(() => window.location.href = 'login.html', 1500);
        return;
      }

      const favoritesList = document.getElementById('favorites-list');

      async function loadFavorites(attempt = 1) {
        favoritesList.innerHTML = '<div class="loading-state">Loading favorites...</div>';

        try {
          const res = await fetch('http://localhost:8080/favorites', {
            headers: { 
              'Authorization': `Bearer ${token}`
            }
          });

          if (!res.ok) {
            if (res.status === 401) {
              showToast('Session expired. Logging out...');
              localStorage.removeItem('token');
              setTimeout(() => window.location.href = 'login.html', 1500);
              return;
            }
            throw new Error(`Server error ${res.status}`);
          }

          const favorites = await res.json();

          const favoritesArray = Array.isArray(favorites) ? favorites : [];

          favoritesList.innerHTML = '';

          if (favoritesArray.length === 0) {
            favoritesList.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    <line x1="4" y1="4" x2="20" y2="20" stroke-width="3" stroke-linecap="round"/>
                  </svg>
                </div>
                <div class="empty-title">No favorites yet</div>
                <div class="empty-subtitle">You haven't saved anyone yet</div>
              </div>
            `;
            return;
          }

          favoritesArray.forEach(item => {
            const user = item.user || {};

            const displayName = user.name || 'User';
            const displayBio = user.bio || 'No bio yet';
            const avatarUrl = user.avatar || fallbackImage;

            const card = document.createElement('div');
            card.className = 'favorite-card';
            card.dataset.userId = item.targetUserId;

            card.innerHTML = `
              <div class="profile-photo">
                <img 
                  src="${avatarUrl}" 
                  alt="${displayName}" 
                  onerror="this.src='${fallbackImage}'"
                >
              </div>
              <div class="user-details">
                <div class="name-age">${displayName}</div>
                <div class="bio-snippet">${displayBio}</div>
                <div class="meta-info">
                  <div>Nearby</div>
                  <div class="status-dot"></div>
                </div>
              </div>
              <div class="favorite-icon">
                <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
              </div>
            `;

            favoritesList.appendChild(card);
          });

        } catch (err) {
          console.error('Favorites load error:', err);
          showToast(`Failed to load favorites (attempt ${attempt})`);

          if (attempt < 3) {
            setTimeout(() => loadFavorites(attempt + 1), 2000);
          } else {
            favoritesList.innerHTML = `
              <div class="empty-state">
                <div class="empty-title">Failed to load</div>
                <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #FFFFFF; color: #000; border: none; border-radius: 20px; cursor: pointer;">Retry</button>
              </div>
            `;
          }
        }
      }

      favoritesList.addEventListener('click', async e => {
        const card = e.target.closest('.favorite-card');
        if (!card || e.target.closest('.favorite-icon')) return;

        const userId = card.dataset.userId;

        try {
          const res = await fetch('http://localhost:8080/chats', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ participants: [userId] })
          });
          if (!res.ok) throw new Error('Failed to create chat');
          showToast('Chat opened!');
          setTimeout(() => window.location.href = `chats.html?id=${userId}`, 800);
        } catch (err) {
          showToast('Failed to open chat');
        }
      });

      favoritesList.addEventListener('click', async e => {
        const iconContainer = e.target.closest('.favorite-icon');
        if (!iconContainer) return;

        const icon = iconContainer.querySelector('svg');
        icon.style.animation = 'pulse 0.5s ease';

        const card = iconContainer.closest('.favorite-card');
        const userId = card.dataset.userId;

        try {
          const res = await fetch('http://localhost:8080/favorite', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ targetUserId: userId })
          });
          if (!res.ok) throw new Error('Failed to remove favorite');

          showToast('Removed from favorites');
          card.style.transition = 'opacity 0.3s ease';
          card.style.opacity = '0';
          setTimeout(() => {
            card.remove();
            if (favoritesList.children.length === 0) {
              favoritesList.innerHTML = `
                <div class="empty-state">
                  <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                      <line x1="4" y1="4" x2="20" y2="20" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                  </div>
                  <div class="empty-title">No favorites yet</div>
                  <div class="empty-subtitle">You haven't saved anyone yet</div>
                </div>
              `;
            }
          }, 300);
        } catch (err) {
          showToast('Failed to remove favorite');
        }
      });

      document.querySelector('.fab').addEventListener('click', () => {
        window.location.href = 'post.html';
      });

      document.getElementById('nav-live').addEventListener('click', () => window.location.href = 'live-requests.html');
      document.getElementById('nav-chats').addEventListener('click', () => window.location.href = 'chats.html');
      document.getElementById('nav-profile').addEventListener('click', () => window.location.href = 'my-profile.html');

      loadFavorites();
    })();
  </script>
</body>
</html>