<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coded | Profile</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000000;
      color: #FFFFFF;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid #2A2A2A;
      position: relative;
    }

    .back-btn {
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .back-btn svg {
      width: 24px;
      height: 24px;
      fill: #FFFFFF;
    }

    .profile-content {
      flex: 1;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-y: auto;
      position: relative; /* for shimmer */
    }

    /* Photos Carousel */
    .photos-carousel {
      position: relative;
      width: 100%;
      max-width: 380px;
      margin-bottom: 32px;
      overflow: hidden;
      border-radius: 20px;
      cursor: pointer;
    }

    .carousel-inner {
      display: flex;
      transition: transform 0.4s ease;
      width: 100%;
    }

    .photo-item {
      min-width: 100%;
      aspect-ratio: 1 / 1;
    }

    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 20px;
    }

    .page-indicators {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
    }

    .indicator {
      width: 8px;
      height: 8px;
      background: #2A2A2A;
      border-radius: 50%;
    }

    .indicator.active {
      background: #FFFFFF;
    }

    /* User Info */
    .user-info {
      text-align: center;
      margin-bottom: 24px;
      width: 100%;
    }

    .name-age {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .bio {
      font-size: 16px;
      color: #8E8E8E;
      line-height: 1.5;
      max-width: 90%;
      margin: 0 auto;
    }

    /* Distance & Status */
    .meta {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      margin-bottom: 24px;
      font-size: 16px;
      color: #8E8E8E;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .available { background: #00FF00; }
    .busy { background: #FFFF00; }
    .offline { background: #FF0000; }

    /* Ratings */
    .rating {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
      font-size: 18px;
    }

    .rating svg {
      width: 24px;
      height: 24px;
      fill: #FFD700;
    }

    .verification {
      font-size: 14px;
      color: #00FF00;
      margin-left: 8px;
    }

    /* Action Buttons */
    .actions {
      width: 100%;
      max-width: 380px;
      margin-bottom: 32px;
    }

    .chat-btn {
      width: 100%;
      height: 52px;
      background: #FFFFFF;
      color: #000000;
      font-size: 17px;
      font-weight: 600;
      border: none;
      border-radius: 26px;
      cursor: pointer;
      margin-bottom: 16px;
      transition: transform 0.1s ease;
    }

    .chat-btn:disabled {
      background: #333333;
      color: #666666;
      cursor: not-allowed;
    }

    .chat-btn:active:not(:disabled) {
      transform: scale(0.98);
    }

    .secondary-actions {
      display: flex;
      justify-content: center;
      gap: 32px;
    }

    .secondary-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 12px;
    }

    .secondary-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .secondary-btn svg {
      width: 28px;
      height: 28px;
      fill: #8E8E8E;
    }

    .favorited svg {
      fill: #FF0000 !important;
    }

    /* Additional Info */
    .additional-info {
      font-size: 14px;
      color: #8E8E8E;
      text-align: center;
      line-height: 1.6;
      width: 100%;
    }

    /* Fullscreen Lightbox */
    .lightbox {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .lightbox.active {
      display: flex;
    }

    .lightbox-carousel {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      overflow-x: scroll;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }

    .lightbox-photo {
      width: 100%;
      height: 100%;
      flex-shrink: 0;
      scroll-snap-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lightbox-photo img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .lightbox-close svg {
      width: 24px;
      height: 24px;
      fill: #FFFFFF;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .profile-content {
        padding: 16px;
      }
      .name-age {
        font-size: 24px;
      }
      .photos-carousel {
        max-width: 100%;
      }
      .actions {
        max-width: 100%;
      }
    }

    /* Shimmer Loading */
    .shimmer-wrapper {
      position: absolute;
      inset: 0;
      padding: 24px;
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.4s ease;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .shimmer-wrapper.hidden { opacity: 0; visibility: hidden; }

    .shimmer-carousel { width: 100%; max-width: 380px; height: 380px; background: #2A2A2A; border-radius: 20px; margin-bottom: 44px; animation: pulse 2s infinite ease-in-out; }

    .shimmer-name { height: 32px; width: 70%; background: #2A2A2A; border-radius: 12px; margin-bottom: 16px; }

    .shimmer-bio { height: 60px; width: 90%; background: #2A2A2A; border-radius: 12px; margin-bottom: 32px; }

    .shimmer-meta { display: flex; gap: 32px; margin-bottom: 32px; }
    .shimmer-meta-item { height: 20px; width: 100px; background: #2A2A2A; border-radius: 12px; }

    .shimmer-rating { height: 28px; width: 120px; background: #2A2A2A; border-radius: 12px; margin-bottom: 40px; }

    .shimmer-chat-btn { width: 100%; max-width: 380px; height: 52px; background: #2A2A2A; border-radius: 26px; margin-bottom: 24px; }

    .shimmer-secondary { display: flex; justify-content: center; gap: 32px; }
    .shimmer-sec-btn { width: 52px; height: 52px; background: #2A2A2A; border-radius: 50%; }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body>
  <header>
    <button class="back-btn" id="back-btn" aria-label="Back">
      <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </button>
  </header>

  <div class="profile-content">
    <!-- Shimmer skeleton -->
    <div class="shimmer-wrapper" id="shimmer">
      <div class="shimmer-carousel"></div>
      <div class="shimmer-name"></div>
      <div class="shimmer-bio"></div>
      <div class="shimmer-meta">
        <div class="shimmer-meta-item"></div>
        <div class="shimmer-meta-item"></div>
      </div>
      <div class="shimmer-rating"></div>
      <div class="shimmer-chat-btn"></div>
      <div class="shimmer-secondary">
        <div class="shimmer-sec-btn"></div>
        <div class="shimmer-sec-btn"></div>
        <div class="shimmer-sec-btn"></div>
      </div>
    </div>

    <!-- Photos Carousel -->
    <div class="photos-carousel" id="carousel">
      <div class="carousel-inner" id="carousel-inner">
      </div>
      <div class="page-indicators" id="indicators"></div>
    </div>

    <!-- User Info -->
    <div class="user-info">
      <div class="name-age">Loading...</div>
      <div class="bio"></div>
    </div>

    <!-- Distance & Status -->
    <div class="meta">
      <div class="distance"></div>
      <div class="status">
        <div class="status-dot offline"></div>
        <span>Offline</span>
      </div>
    </div>

    <!-- Ratings -->
    <div class="rating">
    </div>

    <!-- Action Buttons -->
    <div class="actions">
      <button class="chat-btn">Chat</button>

      <div class="secondary-actions">
        <button class="secondary-btn favorite-btn" aria-label="Favorite">
          <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        </button>
        <button class="secondary-btn" aria-label="Report">
          <svg viewBox="0 0 24 24"><path d="M13 14h-2v-4h2v4zm0 4h-2v-2h2v2zM19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
        </button>
        <button class="secondary-btn" aria-label="Block">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12zm8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8z"/></svg>
        </button>
      </div>
    </div>

    <!-- Additional Info -->
    <div class="additional-info">
    </div>
  </div>

  <!-- Fullscreen Lightbox -->
  <div class="lightbox" id="lightbox">
    <button class="lightbox-close" id="close-lightbox">
      <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
    </button>
    <div class="lightbox-carousel" id="lightbox-carousel">
    </div>
  </div>

  <script>
    const fallbackImage = 'https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png';

    function showToast(message, duration = 2000) {
      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.position = 'fixed';
      toast.style.bottom = '80px';
      toast.style.left = '50%';
      toast.style.transform = 'translateX(-50%)';
      toast.style.background = 'rgba(31, 31, 31, 0.95)';
      toast.style.color = '#FFFFFF';
      toast.style.padding = '8px 16px';
      toast.style.borderRadius = '20px';
      toast.style.fontSize = '13px';
      toast.style.fontWeight = '500';
      toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.4)';
      toast.style.opacity = '0';
      toast.style.visibility = 'hidden';
      toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
      toast.style.zIndex = '200';
      toast.style.maxWidth = '90%';
      toast.style.textAlign = 'center';
      toast.style.backdropFilter = 'blur(8px)';
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.visibility = 'visible';
        toast.style.transform = 'translateX(-50%) translateY(-8px)';
      }, 10);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.visibility = 'hidden';
        toast.style.transform = 'translateX(-50%)';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    (function() {
      const token = localStorage.getItem('token');
      if (!token || token.length < 100) {
        showToast('Invalid or missing session. Please log in.');
        localStorage.removeItem('token');
        setTimeout(() => window.location.href = 'login.html', 1500);
        return;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('id');
      if (!userId) {
        showToast('No user ID provided');
        setTimeout(() => history.back(), 1500);
        return;
      }

      const shimmer = document.getElementById('shimmer');
      let isFavorited = false;

      async function loadProfile() {
        // Show shimmer
        shimmer.classList.remove('hidden');

        let res;
        try {
          res = await fetch(`https://codedsignal.org/user/${userId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
        } catch (err) {
          console.error('Network error:', err);
          showToast('Network error. Please check your connection.');
          shimmer.classList.add('hidden');
          return;
        }

        let user;
        if (!res.ok) {
          user = {
            id: userId,
            name: "Unknown User",
            avatar: fallbackImage,
            status: "offline",
            bio: "This profile is no longer available or has been deleted.",
            photos: [],
            age: null,
            distance: null,
            rating: null,
            verified: false,
            lastActive: null,
            interests: []
          };
          showToast('This profile is no longer available');
        } else {
          try {
            user = await res.json();
          } catch (err) {
            console.error('JSON parse error:', err);
            showToast('Failed to load profile data');
            shimmer.classList.add('hidden');
            return;
          }
        }

        // Hide shimmer
        shimmer.classList.add('hidden');

        // Render user data
        document.querySelector('.name-age').textContent = `${user.name || 'Unknown User'}${user.age ? `, ${user.age}` : ''}`;
        document.querySelector('.bio').textContent = user.bio || '';

        const statusDot = document.querySelector('.status-dot');
        const statusText = document.querySelector('.status span');
        let statusClass = 'offline';
        let statusLabel = 'Offline';
        if (user.status === 'available') {
          statusClass = 'available';
          statusLabel = 'Available';
        } else if (user.status === 'busy') {
          statusClass = 'busy';
          statusLabel = 'Busy';
        }
        statusDot.className = `status-dot ${statusClass}`;
        statusText.textContent = statusLabel;

        const photos = user.photos || (user.avatar ? [user.avatar] : []);
        const carouselInner = document.getElementById('carousel-inner');
        carouselInner.innerHTML = '';
        photos.forEach((src, i) => {
          const item = document.createElement('div');
          item.className = 'photo-item';
          item.innerHTML = `<img src="${src}" alt="Photo ${i+1}" onerror="this.src='${fallbackImage}'">`;
          carouselInner.appendChild(item);
        });

        const indicatorsContainer = document.getElementById('indicators');
        indicatorsContainer.innerHTML = '';
        photos.forEach((_, i) => {
          const dot = document.createElement('div');
          dot.classList.add('indicator');
          if (i === 0) dot.classList.add('active');
          indicatorsContainer.appendChild(dot);
        });

        const distanceEl = document.querySelector('.meta > div:first-child');
        distanceEl.textContent = user.distance ? `${user.distance} km away` : '';

        const ratingEl = document.querySelector('.rating');
        ratingEl.innerHTML = '';
        if (user.rating) {
          ratingEl.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg> ${user.rating}`;
        }
        if (user.verified) {
          const ver = document.createElement('span');
          ver.className = 'verification';
          ver.textContent = 'âœ“ Verified';
          ratingEl.appendChild(ver);
        }

        const additionalInfo = document.querySelector('.additional-info');
        let lastActiveText = user.lastActive ? `Last active ${formatTime(user.lastActive)}` : '';
        let interestsText = user.interests && user.interests.length > 0 ? `Mutual interests: ${user.interests.join(', ')}` : '';
        additionalInfo.innerHTML = `${lastActiveText}${lastActiveText && interestsText ? '<br>' : ''}${interestsText}`;

        // Actions
        if (user.name === "Unknown User") {
          document.querySelector('.chat-btn').disabled = true;
          document.querySelectorAll('.secondary-btn').forEach(btn => btn.disabled = true);
          document.getElementById('carousel').style.display = 'none';
        } else {
          document.querySelector('.chat-btn').onclick = async () => {
            try {
              const res = await fetch('https://codedsignal.org/chats', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ participants: [userId] })
              });
              if (!res.ok) throw new Error('Failed to create chat');
              showToast('Chat created!');
              setTimeout(() => window.location.href = `chats.html?id=${userId}`, 800);
            } catch (err) {
              console.error('Chat creation error:', err);
              showToast('Failed to create chat');
            }
          };
        }

        // Favorites
        try {
          const favRes = await fetch('https://codedsignal.org/favorites', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (favRes.ok) {
            const favorites = await favRes.json();
            isFavorited = favorites.some(f => f.targetUserId === userId);
            if (isFavorited) {
              document.querySelector('.favorite-btn').classList.add('favorited');
            }
          }
        } catch (err) {}

        document.querySelector('.favorite-btn').onclick = async () => {
          if (user.name === "Unknown User") return;
          try {
            const method = isFavorited ? 'DELETE' : 'POST';
            const res = await fetch('https://codedsignal.org/favorite', {
              method,
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
              body: JSON.stringify({ targetUserId: userId })
            });
            if (!res.ok) throw new Error();
            isFavorited = !isFavorited;
            document.querySelector('.favorite-btn').classList.toggle('favorited');
            showToast(isFavorited ? 'Added to favorites' : 'Removed from favorites');
          } catch (err) {
            showToast('Failed to update favorite');
          }
        };

        document.querySelectorAll('.secondary-btn:not(.favorite-btn)').forEach(btn => {
          btn.onclick = () => {
            showToast(`${btn.getAttribute('aria-label')} action not implemented`);
          };
        });

        initializeCarousel();
      }

      function formatTime(timestamp) {
        if (!timestamp) return '';
        const diff = Date.now() - timestamp * 1000;
        if (diff < 60000) return 'just now';
        if (diff < 3600000) return Math.floor(diff / 60000) + ' minutes ago';
        return Math.floor(diff / 3600000) + ' hours ago';
      }

      function initializeCarousel() {
        const carouselInner = document.getElementById('carousel-inner');
        const photos = document.querySelectorAll('.photo-item');
        let currentIndex = 0;

        function updateCarousel() {
          carouselInner.style.transform = `translateX(-${currentIndex * 100}%)`;
          document.querySelectorAll('.indicator').forEach((dot, i) => {
            dot.classList.toggle('active', i === currentIndex);
          });
        }

        if (photos.length > 0) {
          let startX = 0;
          const carousel = document.getElementById('carousel');
          carousel.addEventListener('touchstart', e => startX = e.touches[0].clientX);
          carousel.addEventListener('touchend', e => {
            const endX = e.changedTouches[0].clientX;
            if (startX - endX > 50 && currentIndex < photos.length - 1) currentIndex++;
            else if (endX - startX > 50 && currentIndex > 0) currentIndex--;
            updateCarousel();
          });

          carousel.addEventListener('click', () => {
            const lightbox = document.getElementById('lightbox');
            const lightboxCarousel = document.getElementById('lightbox-carousel');
            lightboxCarousel.innerHTML = '';
            photos.forEach(photo => {
              const clone = photo.cloneNode(true);
              clone.classList.add('lightbox-photo');
              lightboxCarousel.appendChild(clone);
            });
            lightboxCarousel.scrollLeft = currentIndex * window.innerWidth;
            lightbox.classList.add('active');
          });

          updateCarousel();
        } else {
          document.getElementById('carousel').style.display = 'none';
        }
      }

      document.getElementById('close-lightbox').addEventListener('click', () => {
        document.getElementById('lightbox').classList.remove('active');
      });

      document.getElementById('lightbox').addEventListener('click', e => {
        if (e.target === document.getElementById('lightbox')) {
          document.getElementById('lightbox').classList.remove('active');
        }
      });

      document.getElementById('back-btn').addEventListener('click', () => {
        window.history.back();
      });

      loadProfile();
    })();
  </script>
</body>
</html>